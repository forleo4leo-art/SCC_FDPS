// ==UserScript==
// @name FDPS Info Sender
// @namespace http://tampermonkey.net/
// @version 2.0
// @description FDPS (First day pick up success) Information Sender to DSP
// @author forleof
// @match https://logistics.amazon.co.uk/station/dashboard/*
// @match https://logistics.amazon.it/station/dashboard/*
// @require http://code.jquery.com/jquery-3.4.1.min.js
// @grant GM_xmlhttpRequest
// @grant GM.xmlHttpRequest
// @grant GM_addStyle
// @grant GM_getValue
// @grant GM_setValue
// @run-at document-end
// @run-at document-idle
// @updateURL https://axzile.corp.amazon.com/-/carthamus/download_script/fdps-data-sender.user.js
// @downloadURL https://axzile.corp.amazon.com/-/carthamus/download_script/fdps-data-sender.user.js
// ==/UserScript==


(function() {
    'use strict';

    // âœ… AGGIUNGI QUESTA RIGA
    const SCRIPT_VERSION = GM_info.script.version;

// ================================================================================================
// SECTION 0.5: UPDATE SYSTEM
// ================================================================================================

console.log('[FDPS] START SECTION 0.5: Update system');

const UPDATE_CONFIG = {
    UPDATE_URL: 'https://axzile.corp.amazon.com/-/carthamus/download_script/fdps-data-sender.user.js',
    VERSION_CHECK_INTERVAL: 24 * 60 * 60 * 1000, // 24 hours in milliseconds
    LAST_CHECK_KEY: 'fdps_last_update_check',
    DISMISSED_VERSION_KEY: 'fdps_dismissed_version'
};

function checkForUpdates(forceCheck = false) {
    console.log('[FDPS] Checking for updates...', { forceCheck });

    const now = Date.now();
    const lastCheck = GM_getValue(UPDATE_CONFIG.LAST_CHECK_KEY, 0);
    const timeSinceLastCheck = now - lastCheck;

    console.log('[FDPS] Update check info:', {
        now,
        lastCheck,
        timeSinceLastCheck,
        intervalHours: timeSinceLastCheck / (60 * 60 * 1000)
    });

    // Skip check if not forced and checked recently
    if (!forceCheck && timeSinceLastCheck < UPDATE_CONFIG.VERSION_CHECK_INTERVAL) {
        console.log(`[FDPS] Update check skipped. Last check: ${Math.round(timeSinceLastCheck / (60 * 60 * 1000))} hours ago`);
        return;
    }

    console.log('[FDPS] Performing update check...');

    GM_xmlhttpRequest({
        method: 'GET',
        url: UPDATE_CONFIG.UPDATE_URL + '?t=' + now, // Cache busting
        timeout: 15000,
        onload: function(response) {
            console.log('[FDPS] Update check response:', {
                status: response.status,
                responseLength: response.responseText?.length
            });

            try {
                GM_setValue(UPDATE_CONFIG.LAST_CHECK_KEY, now);

                if (response.status === 200) {
                    const remoteScript = response.responseText;
                    const remoteVersion = extractVersionFromScript(remoteScript);
                    const currentVersion = GM_info.script.version;

                    console.log('[FDPS] Version comparison:', {
                        currentVersion,
                        remoteVersion,
                        gmInfoVersion: GM_info.script.version
                    });

                   if (remoteVersion && isNewerVersion(remoteVersion, currentVersion)) {
    const dismissedVersion = GM_getValue(UPDATE_CONFIG.DISMISSED_VERSION_KEY, '');
    console.log('[FDPS] New version found!', {
        remoteVersion,
        currentVersion,
        dismissedVersion
    });

    if (dismissedVersion !== remoteVersion) {
        console.log('[FDPS] Showing update notification');
        showUpdateNotification(remoteVersion, currentVersion);
    } else {
        console.log(`[FDPS] Update ${remoteVersion} was already dismissed`);
    }
} else {
    console.log('[FDPS] No updates available');
                    }
                } else {
                    console.error(`[FDPS] Update check failed: HTTP ${response.status}`);
                }
            } catch (error) {
                console.error(`[FDPS] Update check error:`, error);
            }
        },
        onerror: function(error) {
            console.error(`[FDPS] Update check network error:`, error);
        },
        ontimeout: function() {
            console.error('[FDPS] Update check timed out');
        }
    });
}

function extractVersionFromScript(scriptContent) {
    try {
        // Prova diversi pattern per @version
        const patterns = [
            /@version\s+([^\s\r\n]+)/,
            /@version\s*:\s*([^\s\r\n]+)/,
            /@version\s*=\s*([^\s\r\n]+)/
        ];

        for (let pattern of patterns) {
            const match = scriptContent.match(pattern);
            if (match) {
                const version = match[1].trim();
                console.log('[FDPS] Extracted version:', version, 'using pattern:', pattern);
                return version;
            }
        }

        console.log('[FDPS] No version found in script');
        return null;
    } catch (error) {
        console.error(`[FDPS] Error extracting version:`, error);
        return null;
    }
}

function isNewerVersion(remoteVersion, currentVersion) {
    try {
        console.log('[FDPS] Comparing versions:', { remoteVersion, currentVersion });

        // Convert versions to comparable numbers (e.g., "1.2.3" -> [1, 2, 3])
        const parseVersion = (v) => {
            const cleaned = v.replace(/[^\d\.]/g, ''); // Remove non-numeric chars except dots
            return cleaned.split('.').map(n => parseInt(n, 10) || 0);
        };

        const remote = parseVersion(remoteVersion);
        const current = parseVersion(currentVersion);

        console.log('[FDPS] Parsed versions:', { remote, current });

        // Compare version parts
        for (let i = 0; i < Math.max(remote.length, current.length); i++) {
            const r = remote[i] || 0;
            const c = current[i] || 0;

            console.log(`[FDPS] Comparing part ${i}: remote=${r}, current=${c}`);

            if (r > c) {
                console.log('[FDPS] Remote version is newer');
                return true;
            }
            if (r < c) {
                console.log('[FDPS] Current version is newer');
                return false;
            }
        }

        console.log('[FDPS] Versions are equal');
        return false;
    } catch (error) {
        console.error(`[FDPS] Error comparing versions:`, error);
        return false;
    }
}

function showUpdateNotification(newVersion, currentVersion) {
    console.log(`[FDPS] Creating update notification: ${currentVersion} -> ${newVersion}`);

    // Remove any existing notification
    const existingNotification = document.getElementById('fdps-update-notification');
    if (existingNotification) {
        existingNotification.remove();
    }

    // Create update notification
    const notification = document.createElement('div');
    notification.id = 'fdps-update-notification';
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        width: 380px;
        height: auto;
        max-height: 200px;
        background: linear-gradient(135deg, #4CAF50, #45a049);
        color: white;
        border-radius: 8px;
        box-shadow: 0 6px 25px rgba(0,0,0,0.3);
        z-index: 100000;
        font-family: 'Amazon Ember', Arial, sans-serif;
        animation: slideIn 0.5s ease-out;
        border: 2px solid #66bb6a;
        overflow: hidden;
        display: block;
    `;

    notification.innerHTML = `
        <div style="
            padding: 15px;
            box-sizing: border-box;
            height: auto;
            display: block;
        ">
            <div style="
                display: flex;
                align-items: center;
                margin-bottom: 12px;
                height: auto;
            ">
                <div style="
                    width: 26px;
                    height: 26px;
                    background: white;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin-right: 10px;
                    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
                    flex-shrink: 0;
                ">
                    <span style="color: #4CAF50; font-weight: bold; font-size: 15px;">â†‘</span>
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 700; font-size: 15px; margin-bottom: 2px; line-height: 1.2;">FDPS Update Available!</div>
                    <div style="font-size: 12px; opacity: 0.9; line-height: 1.2;">v${currentVersion} â†’ v${newVersion}</div>
                </div>
            </div>

            <div style="
                font-size: 13px;
                margin-bottom: 15px;
                line-height: 1.3;
                opacity: 0.95;
                height: auto;
            ">
                ðŸš€ New version available with improvements and bug fixes.
            </div>

            <div style="
                display: flex;
                gap: 8px;
                height: auto;
                align-items: stretch;
            ">
                <button id="fdps-update-install" style="
                    flex: 1;
                    padding: 10px 14px;
                    background: white;
                    color: #4CAF50;
                    border: none;
                    border-radius: 5px;
                    font-weight: 700;
                    cursor: pointer;
                    font-size: 13px;
                    transition: all 0.2s ease;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    height: 40px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                ">ðŸ”„ Update Now</button>

                <button id="fdps-update-dismiss" style="
                    padding: 10px 14px;
                    background: rgba(255,255,255,0.15);
                    color: white;
                    border: 1px solid rgba(255,255,255,0.3);
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 13px;
                    transition: all 0.2s ease;
                    font-weight: 600;
                    height: 40px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    white-space: nowrap;
                ">Skip v${newVersion}</button>

                <button id="fdps-update-close" style="
                    padding: 10px 12px;
                    background: rgba(255,255,255,0.1);
                    color: white;
                    border: 1px solid rgba(255,255,255,0.2);
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 16px;
                    line-height: 1;
                    transition: all 0.2s ease;
                    height: 40px;
                    width: 40px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                ">Ã—</button>
            </div>
        </div>
    `;

    document.body.appendChild(notification);
    console.log('[FDPS] Update notification added to DOM');

    // Add animation styles if not already present
    if (!document.getElementById('fdps-update-styles')) {
        const style = document.createElement('style');
        style.id = 'fdps-update-styles';
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }

            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }

            #fdps-update-notification {
                max-height: 200px !important;
                height: auto !important;
                overflow: hidden !important;
            }

            #fdps-update-install:hover {
                background: #f5f5f5 !important;
                box-shadow: 0 3px 8px rgba(0,0,0,0.15) !important;
            }

            #fdps-update-dismiss:hover,
            #fdps-update-close:hover {
                background: rgba(255,255,255,0.25) !important;
            }
        `;
        document.head.appendChild(style);
    }

    // Event handlers
    setTimeout(() => {
        const installBtn = document.getElementById('fdps-update-install');
        const dismissBtn = document.getElementById('fdps-update-dismiss');
        const closeBtn = document.getElementById('fdps-update-close');

        if (installBtn) {
            installBtn.addEventListener('click', () => {
                console.log('[FDPS] User clicked Update Now');

                // âœ… GESTIONE AUTOMATICA DEL TAB DI TAMPERMONKEY
                handleUpdateInstallation();

                closeUpdateNotification();
            });
        }

        if (dismissBtn) {
            dismissBtn.addEventListener('click', () => {
                console.log('[FDPS] User dismissed version', newVersion);
                GM_setValue(UPDATE_CONFIG.DISMISSED_VERSION_KEY, newVersion);
                closeUpdateNotification();
            });
        }

        if (closeBtn) {
            closeBtn.addEventListener('click', () => {
                console.log('[FDPS] User closed notification');
                closeUpdateNotification();
            });
        }
    }, 100);

    // Auto-hide dopo 45 secondi
    setTimeout(() => {
        const notificationElement = document.getElementById('fdps-update-notification');
        if (notificationElement) {
            console.log('[FDPS] Auto-hiding update notification');
            closeUpdateNotification();
        }
    }, 45000);
}

function showNoUpdateNotification(currentVersion) {
    console.log('[FDPS] Showing no update notification');

    // Remove any existing notification
    const existingNotification = document.getElementById('fdps-no-update-notification');
    if (existingNotification) {
        existingNotification.remove();
    }

    const notification = document.createElement('div');
    notification.id = 'fdps-no-update-notification';
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        width: 320px;
        height: auto;
        max-height: 120px;
        background: linear-gradient(135deg, #17a2b8, #138496);
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        z-index: 100000;
        font-family: 'Amazon Ember', Arial, sans-serif;
        animation: slideIn 0.5s ease-out;
        overflow: hidden;
        display: block;
    `;

    notification.innerHTML = `
        <div style="
            padding: 15px;
            box-sizing: border-box;
            height: auto;
            display: block;
        ">
            <div style="
                display: flex;
                align-items: center;
                height: auto;
            ">
                <div style="
                    width: 24px;
                    height: 24px;
                    background: white;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin-right: 10px;
                    flex-shrink: 0;
                ">
                    <span style="color: #17a2b8; font-weight: bold; font-size: 14px;">âœ“</span>
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; font-size: 14px; line-height: 1.2; margin-bottom: 2px;">You're up to date!</div>
                    <div style="font-size: 12px; opacity: 0.9; line-height: 1.2;">FDPS v${currentVersion}</div>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(notification);

    // Auto-hide dopo 3 secondi
    setTimeout(() => {
        if (notification.parentNode) {
            notification.style.animation = 'slideOut 0.3s ease-in forwards';
            setTimeout(() => notification.remove(), 300);
        }
    }, 3000);
}

function closeUpdateNotification() {
    const notification = document.getElementById('fdps-update-notification');
    if (notification) {
        notification.style.animation = 'slideOut 0.3s ease-in forwards';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }
}

function handleUpdateInstallation() {
    console.log('[FDPS] Handling update installation process');

    // âœ… STRATEGIA CON STORAGE E POSTMESSAGE

    // Salva un identificatore unico per questo tab
    const tabId = 'fdps_tab_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    sessionStorage.setItem('fdps_original_tab_id', tabId);
    sessionStorage.setItem('fdps_update_in_progress', 'true');

    console.log('[FDPS] Saved tab identifier:', tabId);

    // Apri il link di aggiornamento in una nuova finestra con parametri specifici
    const updateWindow = window.open(
        UPDATE_CONFIG.UPDATE_URL + '?fdps_return_tab=' + encodeURIComponent(tabId),
        'fdpsUpdate',
        'width=800,height=600,scrollbars=yes,resizable=yes'
    );

    if (updateWindow) {
        console.log('[FDPS] Update window opened successfully');

        // âœ… LISTENER PER MESSAGGI DAL TAB DI UPDATE
        const messageListener = (event) => {
            if (event.data && event.data.type === 'fdps_update_completed') {
                console.log('[FDPS] Received update completion message');
                window.removeEventListener('message', messageListener);

                // Rimuovi lo stato di aggiornamento
                sessionStorage.removeItem('fdps_update_in_progress');

                // Mostra il messaggio di completamento
                showUpdateCompletionMessage();
            }
        };

        window.addEventListener('message', messageListener);

        // âœ… MONITORAGGIO TRADIZIONALE COME BACKUP
        let checkCount = 0;
        const maxChecks = 40;
        let installationDetected = false;

        const monitorUpdate = setInterval(() => {
            checkCount++;
            console.log(`[FDPS] Update check ${checkCount}/${maxChecks}`);

            try {
                // Controlla se la finestra Ã¨ ancora aperta
                if (updateWindow.closed) {
                    console.log('[FDPS] Update window was closed');
                    clearInterval(monitorUpdate);
                    window.removeEventListener('message', messageListener);

                    if (!installationDetected) {
                        // âœ… USA STORAGE EVENT PER SEGNALARE IL COMPLETAMENTO
                        sessionStorage.setItem('fdps_update_completed', Date.now().toString());
                        sessionStorage.removeItem('fdps_update_in_progress');

                        setTimeout(() => {
                            window.focus();
                            showUpdateCompletionMessage();
                        }, 1000);
                    }
                    return;
                }

                // Rilevamento installazione
                let shouldClose = false;

                try {
                    if (updateWindow.document && updateWindow.document.title) {
                        const title = updateWindow.document.title.toLowerCase();
                        console.log('[FDPS] Window title:', title);

                        if (title.includes('tampermonkey') ||
                            title.includes('installed') ||
                            title.includes('userscript') ||
                            title === '' ||
                            title === 'about:blank' ||
                            title.includes('extension')) {
                            shouldClose = true;
                            console.log('[FDPS] Installation detected via title');
                        }
                    }

                    if (updateWindow.location) {
                        const url = updateWindow.location.href;
                        if (url !== UPDATE_CONFIG.UPDATE_URL &&
                            (url.includes('chrome-extension://') ||
                             url.includes('moz-extension://') ||
                             url.includes('about:blank') ||
                             url === '' ||
                             url.includes('tampermonkey'))) {
                            shouldClose = true;
                            console.log('[FDPS] Installation detected via URL change');
                        }
                    }

                } catch (crossOriginError) {
                    if (checkCount > 6) {
                        shouldClose = true;
                        console.log('[FDPS] Installation assumed via cross-origin timing');
                    }
                }

                if (shouldClose && !installationDetected) {
                    installationDetected = true;
                    console.log('[FDPS] Closing update window and returning to original tab...');

                    clearInterval(monitorUpdate);
                    window.removeEventListener('message', messageListener);

                    // âœ… CHIUDI LA FINESTRA E USA STORAGE PER COMUNICARE
                    try {
                        updateWindow.close();
                        console.log('[FDPS] Update window closed');
                    } catch (e) {
                        console.log('[FDPS] Could not close update window');
                    }

                    // Segnala completamento via storage
                    sessionStorage.setItem('fdps_update_completed', Date.now().toString());
                    sessionStorage.removeItem('fdps_update_in_progress');

                    // âœ… FOCUS SULLA FINESTRA CORRENTE E MOSTRA NOTIFICA
                    setTimeout(() => {
                        console.log('[FDPS] Focusing current window and showing notification');

                        // Prova a mettere focus sulla finestra corrente
                        window.focus();

                        // Scroll per "attivare" la finestra
                        const currentScroll = window.pageYOffset;
                        window.scrollTo(0, currentScroll + 1);
                        window.scrollTo(0, currentScroll);

                        showUpdateCompletionMessage();
                    }, 1500);

                    return;
                }

            } catch (generalError) {
                console.log('[FDPS] General monitoring error:', generalError.message);
            }

            // Timeout
            if (checkCount >= maxChecks) {
                console.log('[FDPS] Update monitoring timeout');
                clearInterval(monitorUpdate);
                window.removeEventListener('message', messageListener);

                try {
                    if (!updateWindow.closed) {
                        updateWindow.close();
                    }
                } catch (e) {
                    console.log('[FDPS] Final close attempt failed');
                }

                sessionStorage.setItem('fdps_update_completed', Date.now().toString());
                sessionStorage.removeItem('fdps_update_in_progress');

                setTimeout(() => {
                    window.focus();
                    showUpdateCompletionMessage();
                }, 1000);
            }

        }, 500);

        // Backup timer di 15 secondi
        setTimeout(() => {
            if (!installationDetected) {
                console.log('[FDPS] Backup timer triggered');
                installationDetected = true;
                clearInterval(monitorUpdate);
                window.removeEventListener('message', messageListener);

                try {
                    if (!updateWindow.closed) {
                        updateWindow.close();
                    }
                } catch (e) {}

                sessionStorage.setItem('fdps_update_completed', Date.now().toString());
                sessionStorage.removeItem('fdps_update_in_progress');

                setTimeout(() => {
                    window.focus();
                    showUpdateCompletionMessage();
                }, 1000);
            }
        }, 15000);

    } else {
        console.log('[FDPS] Failed to open update window');
        alert('Could not open update window. Please check your popup blocker settings.');
    }
}

function showUpdateCompletionMessage() {
    console.log('[FDPS] *** SHOWING UPDATE COMPLETION MESSAGE ***');

    // Rimuovi notifiche esistenti per evitare sovrapposizioni
    const existingCompletion = document.getElementById('fdps-update-completion');
    if (existingCompletion) {
        existingCompletion.remove();
    }

    const completionNotification = document.createElement('div');
    completionNotification.id = 'fdps-update-completion';
    completionNotification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        width: 350px;
        height: auto;
        max-height: 150px;
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        border-radius: 8px;
        box-shadow: 0 6px 25px rgba(0,0,0,0.4);
        z-index: 100001;
        font-family: 'Amazon Ember', Arial, sans-serif;
        animation: slideIn 0.5s ease-out;
        overflow: hidden;
        display: block !important;
        border: 2px solid #20c997;
    `;

    completionNotification.innerHTML = `
        <div style="
            padding: 15px;
            box-sizing: border-box;
            height: auto;
            display: block;
        ">
            <div style="
                display: flex;
                align-items: center;
                margin-bottom: 10px;
                height: auto;
            ">
                <div style="
                    width: 26px;
                    height: 26px;
                    background: white;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin-right: 10px;
                    flex-shrink: 0;
                    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
                ">
                    <span style="color: #28a745; font-weight: bold; font-size: 16px;">âœ“</span>
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 700; font-size: 15px; line-height: 1.2;">Update Installed!</div>
                    <div style="font-size: 12px; opacity: 0.9; line-height: 1.2;">Please refresh the page to use the new version</div>
                </div>
            </div>

            <div style="
                display: flex;
                gap: 8px;
                height: auto;
                align-items: stretch;
            ">
                <button id="fdps-refresh-page" style="
                    flex: 1;
                    padding: 10px 14px;
                    background: white;
                    color: #28a745;
                    border: none;
                    border-radius: 5px;
                    font-weight: 700;
                    cursor: pointer;
                    font-size: 13px;
                    transition: all 0.2s ease;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    height: 38px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                ">ðŸ”„ Refresh Page</button>

                <button id="fdps-close-completion" style="
                    padding: 10px 12px;
                    background: rgba(255,255,255,0.1);
                    color: white;
                    border: 1px solid rgba(255,255,255,0.2);
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 16px;
                    line-height: 1;
                    transition: all 0.2s ease;
                    height: 38px;
                    width: 38px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                ">Ã—</button>
            </div>
        </div>
    `;

    document.body.appendChild(completionNotification);
    console.log('[FDPS] Update completion notification added to DOM');

    // Event handlers
    setTimeout(() => {
        const refreshBtn = document.getElementById('fdps-refresh-page');
        const closeBtn = document.getElementById('fdps-close-completion');

        console.log('[FDPS] Setting up completion handlers:', { refreshBtn, closeBtn });

        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => {
                console.log('[FDPS] User clicked refresh');
                window.location.reload();
            });
        }

        if (closeBtn) {
            closeBtn.addEventListener('click', () => {
                console.log('[FDPS] User closed completion notification');
                if (completionNotification.parentNode) {
                    completionNotification.style.animation = 'slideOut 0.3s ease-in forwards';
                    setTimeout(() => completionNotification.remove(), 300);
                }
            });
        }
    }, 100);

    // Auto-hide dopo 15 secondi (aumentato)
    setTimeout(() => {
        console.log('[FDPS] Auto-hiding completion notification');
        if (completionNotification.parentNode) {
            completionNotification.style.animation = 'slideOut 0.3s ease-in forwards';
            setTimeout(() => completionNotification.remove(), 300);
        }
    }, 15000);
}

function showManualUpdateInstructions() {
    console.log('[FDPS] Showing manual update instructions');

    alert(`FDPS Update Instructions:

1. The update page should have opened in a new tab
2. Click "Install" in Tampermonkey when prompted
3. Close the update tab after installation
4. Refresh this page to use the new version

If the tab didn't open, please visit:
${UPDATE_CONFIG.UPDATE_URL}`);
}

console.log('[FDPS] END SECTION 0.5: Update system');


// ================================================================================================
// SECTION 1: CONFIGURATION AND CONSTANTS
// ================================================================================================

console.log('[FDPS] START SECTION 1: Configuration and constants');

// SCRIPT_VERSION Ã¨ giÃ  dichiarato all'inizio dello script - NON ridichiarare qui

// API Configuration
const API_CONFIG = {
    ENDPOINT: '/station/proxyapigateway/data',
    RESOURCE_PATH: '/os/getPackageHistoryData',
    HTTP_METHOD: 'post',
    PROCESS_NAME: 'oculus',
    PAGE_SIZE: 100,
    TARGET_CURRENT_STATUS: 'Delivered',
    TARGET_OPERATION: 'Route Assignment',
    TARGET_EVENT_PROCESSOR: 'RPMRoutePlanner'
};

// ================================================================================================
// SUBSECTION 1.1: DS AND DSP CONFIGURATION
// ================================================================================================

// DS Configuration Storage
const DS_CONFIG_STORAGE_KEY = 'fdps_ds_configuration';
const DS_CONFIG_VERSION = '1.0';

// Configuration Template
const DEFAULT_DS_CONFIG = {
    version: DS_CONFIG_VERSION,
    ds_info: {
        name: "DS_NAME",           // Nome DS per titlebar e email
        mercury_url: ""            // URL Mercury specifico DS
    },
    dsps: []                      // Array dinamico DSP
};

// Current DLZ3 Configuration (fallback per installazioni esistenti)
const DLZ3_CONFIG = {
    version: DS_CONFIG_VERSION,
    ds_info: {
        name: "DLZ3",
        mercury_url: "https://c3.amazon.com/eu/mercury_amzl/#/dashboard/elasticsearch/1b04fe6a-751e-323f-b7b7-f45413ed2daa"
    },
    dsps: [
        {
            "code": "HDS",
            "name": "Global One",
            "color_hex": "#2b77d5",
            "emails": [
                "dlz3@globalonespa.it",
                "superdriver.dlz3@globalonespa.it",
                "it-amzl-dlz3-mgmt@amazon.com"
            ],
            "chime_webhook_url": "https://hooks.chime.aws/incomingwebhooks/89f8ad9d-0bd7-4bf4-b49e-8203a16e91a1?token=QnVUdUxpckJ8MXxfVW1CSUdqTUZkQlp5bFo1NHNicUZvaVc0QWRiZFRhX3RZWmhRTHdKR0FR"
        },
        {
            "code": "UNAS",
            "name": "Unicotras",
            "color_hex": "#ffff00",
            "emails": [
                "leuzzi.giada@unicotras.it",
                "schiera.gianluca@unicotras.it",
                "lolli.mirko@unicotras.it",
                "ripani.martina@unicotras.it",
                "leuzzi.andrea@unicotras.it",
                "it-amzl-dlz3-mgmt@amazon.com"
            ],
            "chime_webhook_url": "https://hooks.chime.aws/incomingwebhooks/fd8eb7fd-6117-41d2-9fe7-108031ee75c3?token=Y05qZmViOEd8MXxPTWEyNENZYWZEM19QbG1PVTE1dEx2UTdlb0VMcjRsc3NnbTJsY3M0NG1N"
        },
        {
            "code": "SPEO",
            "name": "Spedireroma",
            "color_hex": "#ff8040",
            "emails": [
                "a.camponeschi@spedireroma.it",
                "a.disomma@spedireroma.it",
                "a.amura@spedireroma.it",
                "d.mortini@spedireroma.it",
                "osm@spedireroma.it",
                "it-amzl-dlz3-mgmt@amazon.com"
            ],
            "chime_webhook_url": "https://hooks.chime.aws/incomingwebhooks/49b478cf-22ad-420f-9ada-3ecfb00f30b4?token=RExQaTRDeXZ8MXxTSVlKa0tqZTZ5TzdIaGpkMVZubzNsb002d0FvNW1FSGRCUzliOFg1NUFF"
        },
        {
            "code": "H&F",
            "name": "H&F SPA",
            "color_hex": "#000000",
            "emails": [
                "dispatcher.roma1@hefitalia.com",
                "dispatcher.roma2@hefitalia.com",
                "dispatcher.roma3@hefitalia.com",
                "dispatcher.roma5@hefitalia.com",
                "it-amzl-dlz3-mgmt@amazon.com"
            ],
            "chime_webhook_url": "https://hooks.chime.aws/incomingwebhooks/b958f14f-9840-4413-bc28-b40bff589067?token=NlRwRHd1bnl8MXx0Y3hCbTZhdnVBa2hNYlZia3FNWHo5ekg5QWRBYjVoQzY5c0ZkUEphRmN3"
        },
        {
            "code": "RANZ",
            "name": "Randazzo srl",
            "color_hex": "#008000",
            "emails": [
                "cristian.rossi@randazzosrl.it",
                "dsantacroce@randazzosrl.it",
                "alessandro.spada@randazzosrl.it",
                "fabrizio.dalcorso@randazzosrl.it",
                "simone.petrosino@randazzosrl.it",
                "dspmagliana@randazzosrl.it",
                "it-amzl-dlz3-mgmt@amazon.com"
            ],
            "chime_webhook_url": "https://hooks.chime.aws/incomingwebhooks/8edfc93f-1fb0-4e13-9f16-4c84c0898aab?token=bG9xaEI4Vmp8MXxsbjFKbDJCWTFKazFkbnIyTWhMdFk0T0FtMkVhV3NtalBvY2JLZTBraVl3"
        }
    ]
};

// Global Configuration
let CURRENT_DS_CONFIG = null;

// Load configuration from storage
function loadDSConfiguration() {
    const storedConfig = GM_getValue(DS_CONFIG_STORAGE_KEY, null);

    if (storedConfig) {
        try {
            CURRENT_DS_CONFIG = JSON.parse(storedConfig);
            debugLog(`âœ… Loaded DS configuration: ${CURRENT_DS_CONFIG.ds_info.name}`);
            return CURRENT_DS_CONFIG;
        } catch (error) {
            debugLog(`âŒ Error parsing stored DS config: ${error.message}`);
        }
    }

    // First time setup - use DLZ3 as fallback for existing users
    debugLog('ðŸ”§ No configuration found, migrating DLZ3 setup...');
    CURRENT_DS_CONFIG = DLZ3_CONFIG;
    saveDSConfiguration(CURRENT_DS_CONFIG);
    return CURRENT_DS_CONFIG;
}

// Save configuration to storage
function saveDSConfiguration(config) {
    try {
        GM_setValue(DS_CONFIG_STORAGE_KEY, JSON.stringify(config));
        CURRENT_DS_CONFIG = config;
        debugLog(`ðŸ’¾ Saved DS configuration: ${config.ds_info.name}`);
        return true;
    } catch (error) {
        debugLog(`âŒ Error saving DS configuration: ${error.message}`);
        return false;
    }
}

// Initialize configuration
CURRENT_DS_CONFIG = loadDSConfiguration();

// Legacy compatibility - update existing DSP_CONFIG reference
const DSP_CONFIG = {
    "dsps": CURRENT_DS_CONFIG ? CURRENT_DS_CONFIG.dsps : []
};

// ================================================================================================
// SUBSECTION 1.2: COMMUNICATION TEMPLATES
// ================================================================================================

const COMMUNICATION_TEMPLATES = {
    email: {
        // âœ… Dynamic DS name in subject
        get subject() {
            const dsName = CURRENT_DS_CONFIG?.ds_info?.name || 'DS';
            return `[${dsName}]-Customer Returns - {DSP_CODE} - Critical Pickups Alert - {DATE}`;
        },
        header: `Dear {DSP_NAME} Team,

Following today's FDPS analysis, we've identified pickup items requiring attention:

ðŸ“Š Summary:
â€¢ Total Pickups: {TOTAL_PICKUPS}
âš ï¸ {CRITICAL_PICKUPS} CRITICAL ITEMS (1 day) marked with ðŸ”´ - These items require IMMEDIATE attention!

ðŸ“‹ DETAILED BREAKDOWN:`,
        // âœ… Dynamic DS name in footer
        get footer() {
            const dsName = CURRENT_DS_CONFIG?.ds_info?.name || 'DS';
            return `

Best regards,
Amazon Logistics Team - ${dsName}

---
This is an automated message from FDPS Analysis Tool v{SCRIPT_VERSION}
Generated on {TIMESTAMP}`;
        }
    },
    chime: {
        template: `ðŸš¨ **FDPS Alert - {DSP_CODE}**

ðŸ“Š **Pickup Summary:**
â€¢ Total: {TOTAL_PICKUPS} pickups
â€¢ Critical (1 day): {CRITICAL_PICKUPS}
â€¢ Routes: {ROUTES_LIST}
â€¢ HUB/COUNTER: {HUB_COUNT} | LOCKER: {LOCKER_COUNT}

âš ï¸ {CRITICAL_PICKUPS} packages require immediate attention!

ðŸ“‹ **Critical Items:**
{CRITICAL_ITEMS_LIST}

ðŸ“… Date: {DATE}
ðŸ”— Detailed report sent via email`
    }
};

// Global script state
const scriptState = {
    initialized: false,
    processing: false,
    currentData: {
        pickups: [],
        addresses: [],
        processedResults: []
    },
    notLinkedCount: 0
};

// General configuration
const CONFIG = {
    RETRY_DELAY: 2000, // âœ… Aumentato da 1000ms a 2000ms
    MAX_RETRIES: 5, // âœ… Aumentato da 3 a 5 tentativi
    REQUEST_TIMEOUT: 45000, // âœ… Aumentato da 30000ms a 45000ms
    BATCH_SIZE: 5, // âœ… Ridotto da 10 a 5 per meno stress sul server
    DEBOUNCE_DELAY: 300
};

console.log('[FDPS] END SECTION 1: Configuration and constants');


// ================================================================================================
// SEZIONE 2: UTILITIES E FUNZIONI DI SUPPORTO
// ================================================================================================

console.log('[FDPS] START SECTION 2: Utilities and support functions');

// Debug logging function
function debugLog(message) {
    console.log(`[FDPS] ${message}`);
}

// Debounce utility
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Date formatting utility
function formatDate(timestamp) {
    if (!timestamp) return '';
    return new Date(timestamp).toLocaleString('en-GB');
}

// Function to validate CSV structure
function validateCSVStructure(data, expectedColumns) {
    if (!data || data.length === 0) {
        return { valid: false, error: 'Empty file' };
    }

    const headers = data[0];
    const missingColumns = expectedColumns.filter(col => !headers.includes(col));

    if (missingColumns.length > 0) {
        return {
            valid: false,
            error: `Missing columns: ${missingColumns.join(', ')}`
        };
    }

    return { valid: true };
}

// Enhanced CSV parser
function parseCSV(csvText) {
    const lines = csvText.split('\n').filter(line => line.trim());
    if (lines.length === 0) return [];

    const result = [];
    for (let line of lines) {
        const row = [];
        let current = '';
        let inQuotes = false;

        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            if (char === '"' && (i === 0 || line[i-1] !== '\\')) {
                inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
                row.push(current.trim());
                current = '';
            } else {
                current += char;
            }
        }
        row.push(current.trim());
        result.push(row);
    }

    return result;
}

// âœ… TOGGLE BUTTON STATE MANAGEMENT - AGGIORNATO CON PROGRESS BAR BIANCA STILE SCC
function setToggleButtonState(state, progress = 0) {
    const toggleButton = document.getElementById('fdpsToggle');
    if (!toggleButton) return;

    // Remove all state classes
    toggleButton.classList.remove('searching', 'completed');

    switch(state) {
        case 'idle':
            toggleButton.innerHTML = 'FDPS Info Sender';
            toggleButton.style.backgroundColor = 'rgb(7, 115, 152)';
            toggleButton.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
            toggleButton.style.animation = 'none';
            toggleButton.style.fontSize = '14px';
            toggleButton.style.lineHeight = 'normal';
            toggleButton.style.padding = '8px 16px';
            toggleButton.style.height = 'auto';
            debugLog('Toggle button set to IDLE state');
            break;

        case 'searching':
            toggleButton.classList.add('searching');
            // Layout identico al SCC - solo barra sotto il testo
            toggleButton.innerHTML = `
                <div style="position: relative; display: inline-block;">
                    <span style="font-size: 14px; font-weight: 500;">FDPS Info Sender</span>
                    <div style="
                        position: absolute;
                        bottom: -3px;
                        left: 0;
                        right: 0;
                        height: 2px;
                        background: rgba(255,255,255,0.3);
                        border-radius: 1px;
                        overflow: hidden;
                    ">
                        <div style="
                            width: ${Math.max(progress, 2)}%;
                            height: 100%;
                            background: rgba(255,255,255,0.9);
                            border-radius: 1px;
                            transition: width 0.3s ease;
                        "></div>
                    </div>
                </div>
            `;
            toggleButton.style.fontSize = '14px';
            toggleButton.style.lineHeight = 'normal';
            toggleButton.style.padding = '8px 16px';
            toggleButton.style.height = 'auto';
            debugLog(`Toggle button set to SEARCHING state - ${Math.round(progress)}%`);
            break;

        case 'completed':
            toggleButton.classList.add('completed');
            toggleButton.innerHTML = `
                <div style="position: relative; display: inline-block;">
                    <span style="font-size: 14px; font-weight: 500;">FDPS Info Sender</span>
                    <div style="
                        position: absolute;
                        bottom: -3px;
                        left: 0;
                        right: 0;
                        height: 2px;
                        background: rgba(255,255,255,0.3);
                        border-radius: 1px;
                        overflow: hidden;
                    ">
                        <div style="
                            width: 100%;
                            height: 100%;
                            background: rgba(255,255,255,0.95);
                            border-radius: 1px;
                        "></div>
                    </div>
                </div>
            `;
            toggleButton.style.fontSize = '14px';
            toggleButton.style.lineHeight = 'normal';
            toggleButton.style.padding = '8px 16px';
            toggleButton.style.height = 'auto';
            debugLog('Toggle button set to COMPLETED state');
            break;
    }
}



// âœ… AGGIORNA PULSANTE START ANALYSIS CON PROGRESS BAR IN BACKGROUND E INTEGRAZIONE DSP CENTER
function setProcessButtonState(state, progress = 0, message = '', dspStats = null) {
    const processButton = document.getElementById('processButton');
    if (!processButton) return;

    // Remove all state classes
    processButton.classList.remove('processing', 'completed');

    switch(state) {
        case 'ready':
            processButton.innerHTML = 'ðŸš€ Start Analysis';
            processButton.style.background = 'rgb(7, 115, 152)';
            processButton.style.color = 'white';
            processButton.disabled = false;
            processButton.style.opacity = '1';
            processButton.style.cursor = 'pointer';
            processButton.style.transition = 'all 0.3s ease';

            // âœ… RESET CLICK HANDLER A FUNZIONE ORIGINALE
processButton.onclick = startAnalysis;
debugLog('Process button set to READY state');
break;

case 'processing': {  // âœ… AGGIUNGI QUESTA PARENTESI GRAFFA
    processButton.classList.add('processing');

    // âœ… GRADIENT DI BACKGROUND: BLU â†’ ARANCIONE BASATO SUL PROGRESSO
    const progressPercent = Math.max(progress, 2);
    processButton.style.background = `linear-gradient(90deg,
        #ff6b35 0%,
        #ff6b35 ${progressPercent}%,
        rgb(7, 115, 152) ${progressPercent}%,
        rgb(7, 115, 152) 100%)`;

    processButton.innerHTML = `<span style="position: relative; z-index: 2; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">${message || 'Processing...'}</span>`;
    processButton.style.color = 'white';
    processButton.disabled = true;
    processButton.style.opacity = '1';
    processButton.style.cursor = 'not-allowed';
    processButton.style.transition = 'background 0.3s ease';
    break;
}

            // âœ… RIMUOVI CLICK HANDLER DURANTE PROCESSING
            processButton.onclick = null;

            debugLog(`Process button set to PROCESSING state - ${Math.round(progress)}% - ${message}`);
            break;

        case 'completed':
            processButton.classList.add('completed');

            // âœ… BACKGROUND COMPLETAMENTE VERDE
            processButton.style.background = 'linear-gradient(135deg, #28a745, #20c997)';

            if (dspStats) {
                processButton.innerHTML = `
                    <div style="position: relative; z-index: 2; text-shadow: 0 1px 2px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 2px;">
                        <div style="font-size: 13px; font-weight: 600;">âœ… Analysis Complete!</div>
                        <div style="font-size: 11px; opacity: 0.9;">${dspStats.dspCount} DSP${dspStats.dspCount > 1 ? 's' : ''} â€¢ ${dspStats.criticalCount} critical â€¢ ðŸ“§ Click to send notifications</div>
                    </div>
                `;
            } else {
                processButton.innerHTML = `<span style="position: relative; z-index: 2; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">âœ… Analysis Complete!</span>`;
            }

            processButton.style.color = 'white';
            processButton.disabled = false;
            processButton.style.opacity = '1';
            processButton.style.cursor = 'pointer';
            processButton.style.transition = 'all 0.3s ease';

            // âœ… SOSTITUISCI COMPLETAMENTE IL CLICK HANDLER CON SCROLL TO DSP CENTER
            processButton.onclick = scrollToDSPCenter;

            debugLog('Process button set to COMPLETED state with DSP Center integration');
            break;

        case 'disabled':
            processButton.innerHTML = 'ðŸš€ Start Analysis';
            processButton.style.background = 'rgb(7, 115, 152)';
            processButton.style.color = 'white';
            processButton.disabled = true;
            processButton.style.opacity = '0.5';
            processButton.style.cursor = 'not-allowed';
            processButton.style.transition = 'all 0.3s ease';

            // âœ… RIMUOVI CLICK HANDLER QUANDO DISABLED
            processButton.onclick = null;

            debugLog('Process button set to DISABLED state');
            break;
    }
}

// âœ… NUOVA FUNZIONE PER SCROLL TO DSP CENTER
function scrollToDSPCenter() {
    const dspCenter = document.getElementById('dsp-communication-center');
    if (dspCenter) {
        dspCenter.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
        });

        // Highlight temporaneo del DSP center
        dspCenter.style.border = '3px solid #28a745';
        dspCenter.style.borderRadius = '8px';
        dspCenter.style.backgroundColor = '#e8f5e8';
        dspCenter.style.transition = 'all 0.3s ease';

        setTimeout(() => {
            dspCenter.style.border = '';
            dspCenter.style.borderRadius = '';
            dspCenter.style.backgroundColor = '';
        }, 3000);

        debugLog('Scrolled to DSP Communication Center');
    } else {
        debugLog('DSP Communication Center not found');
    }
}

// âœ… DICHIARAZIONE ANTICIPATA DI startAnalysis PER EVITARE ERRORI DI RIFERIMENTO
async function startAnalysis() {
    if (scriptState.processing) {
        debugLog('Analysis already in progress');
        return;
    }

    try {
        scriptState.processing = true;
        setToggleButtonState('searching', 0);
        setProcessButtonState('processing', 0, 'Initializing...'); // âœ… NUOVO STATO

        // Create abort controller
        window.fdpsAbortController = new AbortController();

        // Show progress
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const apiTimer = document.getElementById('apiTimer');

        progressContainer.style.display = 'block';

        // Start timer
        const startTime = Date.now();
        const timerInterval = setInterval(() => {
            if (window.fdpsAbortController?.signal.aborted) {
                clearInterval(timerInterval);
                return;
            }

            const elapsedTime = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsedTime / 60);
            const seconds = elapsedTime % 60;
            apiTimer.textContent = `Time: ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }, 1000);

        // Process data
        debugLog('Processing CSV data...');
        setProcessButtonState('processing', 5, 'Processing CSV data...'); // âœ… AGGIORNA PULSANTE

        const validPickups = processData();

        if (validPickups.length === 0) {
            throw new Error('No valid data found (all pickups have trackingId = Related Delivery)');
        }

        debugLog(`Starting API calls for ${validPickups.length} records`);
        setProcessButtonState('processing', 10, `Starting API calls (${validPickups.length} records)...`); // âœ… AGGIORNA

        // âœ… TEST CON PRIMO ELEMENTO PRIMA DI PROCESSARE TUTTO
        debugLog('ðŸ§ª Testing FDPS API with first tracking...');
        const firstTracking = validPickups[0].relatedDelivery;
        const testResult = await makeDriverAssignmentRequest(firstTracking);
        debugLog('ðŸ§ª Test result:', testResult);

        // Se il test fallisce completamente, ferma tutto
        if (testResult.errorType === 'NETWORK_ERROR') {
            throw new Error(`API connection failed: ${testResult.message}`);
        }

        setProcessButtonState('processing', 15, 'API connection verified...'); // âœ… AGGIORNA

        // Process in batches
        for (let i = 0; i < validPickups.length; i += CONFIG.BATCH_SIZE) {
            if (window.fdpsAbortController?.signal.aborted) {
                debugLog('Analysis cancelled by user');
                break;
            }

            const batch = validPickups.slice(i, i + CONFIG.BATCH_SIZE);
            const batchNumber = Math.ceil((i + 1) / CONFIG.BATCH_SIZE);
            const totalBatches = Math.ceil(validPickups.length / CONFIG.BATCH_SIZE);

            debugLog(`Processing batch ${batchNumber} of ${totalBatches}: ${batch.map(r => r.relatedDelivery).join(', ')}`);

            // âœ… AGGIORNA IL PULSANTE CON BATCH INFO
            const batchProgress = 15 + ((i / validPickups.length) * 75); // Da 15% a 90%
            setProcessButtonState('processing', batchProgress, `Processing batch ${batchNumber}/${totalBatches}...`);

            // âœ… NUOVA LOGICA: chiamate API sia per FDPS che per Pickup Failed
const promises = batch.map(async (record) => {
    // Chiamata API originale per FDPS (con relatedDelivery)
    const fdpsResult = await makeDriverAssignmentRequest(record.relatedDelivery);

    // âœ… NUOVA CHIAMATA API per Pickup Failed (con trackingId)
    const pickupResult = await makePickupFailedRequest(record.trackingId);

    return {
        fdps: fdpsResult,
        pickup: pickupResult
    };
});

const results = await Promise.all(promises);

// Update records with API results
results.forEach((result, batchIndex) => {
    const recordIndex = i + batchIndex;
    if (recordIndex < validPickups.length) {
        // âœ… FDPS originale
        validPickups[recordIndex].fdpsDays = result.fdps.days || 0;
        validPickups[recordIndex].routeCode = result.fdps.routeCode || '';

        // âœ… NUOVI CAMPI PICKUP FAILED
        validPickups[recordIndex].lastPickup = result.pickup.lastPickup || '';
        validPickups[recordIndex].lastDatePickup = result.pickup.lastDatePickup || '';
        validPickups[recordIndex].lastReasonPickup = result.pickup.lastReasonPickup || '';

        if (result.fdps.error || result.pickup.error) {
            debugLog(`API error for ${validPickups[recordIndex].relatedDelivery} / ${validPickups[recordIndex].trackingId}`);
        } else {
            debugLog(`API success for ${validPickups[recordIndex].relatedDelivery}: ${result.fdps.days} days, pickup: ${result.pickup.lastPickup}`);
        }
    }
});


            // Update progress
            const progress = Math.round(((i + batch.length) / validPickups.length) * 100);
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${progress}%`;
            setToggleButtonState('searching', progress);

            debugLog(`Completed batch ${Math.ceil((i + batch.length) / CONFIG.BATCH_SIZE)}, progress: ${progress}%`);
        }

        // Clean up timer
        clearInterval(timerInterval);

        if (!window.fdpsAbortController?.signal.aborted) {
            // âœ… FINALIZING STATE
            setProcessButtonState('processing', 95, 'Finalizing results...');

            // Store results and show view
            scriptState.currentData.processedResults = validPickups;
            populateDataView(validPickups);

            setToggleButtonState('completed');

            // âœ… IL PULSANTE VIENE AGGIORNATO DENTRO populateDataView CON LE STATS
            debugLog(`Analysis completed: ${validPickups.length} records processed`);
        }

        // Hide progress
        progressContainer.style.display = 'none';

    } catch (error) {
        debugLog(`Analysis error: ${error.message}`);
        alert(`Error during analysis: ${error.message}`);
        setToggleButtonState('idle');
        setProcessButtonState('ready'); // âœ… RESET PULSANTE

        // Hide progress on error
        const progressContainer = document.getElementById('progressContainer');
        if (progressContainer) progressContainer.style.display = 'none';

    } finally {
        scriptState.processing = false;
        window.fdpsAbortController = null;

        if (window.updateProcessButtonState) {
            window.updateProcessButtonState();
        }
    }
}

// âœ… FUNZIONE processData SPOSTATA QUI PER ESSERE DISPONIBILE
function processData() {
    const pickups = scriptState.currentData.pickups;
    const addresses = scriptState.currentData.addresses;

    if (pickups.length === 0 || addresses.length === 0) {
        throw new Error('Missing data');
    }

    // Find column indices for pickups file
    const pickupsHeaders = pickups[0];
    const trackingIdIndex = pickupsHeaders.indexOf('trackingId');
    const relatedDeliveryIndex = pickupsHeaders.indexOf('Related Delivery');
    const dspIndex = pickupsHeaders.indexOf('Dsp');
    const transporterIdIndex = pickupsHeaders.findIndex(h =>
        h.includes('LMTRUpdates.PTRAS.trAssignmentChange.transporterDetails.transporterId')
    );
    const pickupTypeIndex = pickupsHeaders.indexOf('Pick up Type');

    if (trackingIdIndex === -1 || relatedDeliveryIndex === -1) {
        throw new Error('Required columns not found in pickups file');
    }

    debugLog(`Found columns - trackingId: ${trackingIdIndex}, relatedDelivery: ${relatedDeliveryIndex}, dsp: ${dspIndex}, transporterId: ${transporterIdIndex}, pickupType: ${pickupTypeIndex}`);

    // Find column indices for addresses file
    const addressesHeaders = addresses[0];
    const queryItemIndex = addressesHeaders.indexOf('Query_Item');
    const addressLine1Index = addressesHeaders.indexOf('Address_Line_1');
    const addressLine2Index = addressesHeaders.indexOf('Address_Line_2');
    const addressLine3Index = addressesHeaders.indexOf('Address_Line_3');
    const cityIndex = addressesHeaders.indexOf('City');
    const postalCodeIndex = addressesHeaders.indexOf('Postal_Code');

    if (queryItemIndex === -1) {
        throw new Error('Query_Item column not found in addresses file');
    }

    debugLog(`Found address columns - queryItem: ${queryItemIndex}, addressLine1: ${addressLine1Index}, city: ${cityIndex}, postalCode: ${postalCodeIndex}`);

    // Create address lookup map
    const addressMap = new Map();
    for (let i = 1; i < addresses.length; i++) {
        const row = addresses[i];
        const queryItem = row[queryItemIndex];

        if (queryItem) {
            const addressParts = [
                row[addressLine1Index] || '',
                row[addressLine2Index] || '',
                row[addressLine3Index] || '',
                row[cityIndex] || '',
                row[postalCodeIndex] || ''
            ].filter(part => part.trim()).join(', ');

            addressMap.set(queryItem, addressParts);
        }
    }

    debugLog(`Created address map with ${addressMap.size} entries`);

    // âœ… COUNT NOT LINKED (trackingId = Related Delivery) - STORE GLOBALLY
    let notLinkedCount = 0;
    for (let i = 1; i < pickups.length; i++) {
        const row = pickups[i];
        const trackingId = row[trackingIdIndex];
        const relatedDelivery = row[relatedDeliveryIndex];

        if (trackingId && relatedDelivery && trackingId === relatedDelivery) {
            notLinkedCount++;
        }
    }

    // Store globally for footer display
    scriptState.notLinkedCount = notLinkedCount;
    debugLog(`Found ${notLinkedCount} not linked tracking IDs (trackingId = Related Delivery)`);

    // Filter and process pickups data
    const validPickups = [];
    for (let i = 1; i < pickups.length; i++) {
        const row = pickups[i];
        const trackingId = row[trackingIdIndex];
        const relatedDelivery = row[relatedDeliveryIndex];

        // Filter condition: trackingId â‰  Related Delivery
        if (trackingId && relatedDelivery && trackingId !== relatedDelivery) {
            // âœ… CONVERT NOREASON TO HUB/COUNTER
            let pickupType = row[pickupTypeIndex] || '';
            if (pickupType === 'NOREASON') {
                pickupType = 'HUB/COUNTER';
            }

const record = {
    trackingId: trackingId,
    relatedDelivery: relatedDelivery,
    dsp: row[dspIndex] || '',
    transporterId: row[transporterIdIndex] || '',
    pickupType: pickupType,
    address: addressMap.get(relatedDelivery) || 'Address not found',
    fdpsDays: 0, // Will be populated by API calls
    routeCode: '', // Will be populated by API calls
    // âœ… NUOVI CAMPI PER PICKUP FAILED (vuoti per ora)
    lastPickup: '',
    lastDatePickup: '',
    lastReasonPickup: ''
};

            validPickups.push(record);
            debugLog(`Added valid pickup: ${relatedDelivery} (trackingId: ${trackingId})`);
        } else {
            debugLog(`Skipped pickup: trackingId=${trackingId}, relatedDelivery=${relatedDelivery} (same values or empty)`);
        }
    }

    debugLog(`Filtered ${validPickups.length} valid pickups from ${pickups.length - 1} total`);

    return validPickups;
}

    console.log('[FDPS] END SECTION 2: Utilities and support functions');


// ================================================================================================
// SECTION 3: UI ELEMENTS CREATION
// ================================================================================================

console.log('[FDPS] START SECTION 3: UI elements creation');

function createToggleButton() {
    debugLog('Creating toggle button');
    const toggleButton = document.createElement('button');
    toggleButton.id = 'fdpsToggle';
    toggleButton.textContent = 'FDPS Info Sender';

    // CSS identico al SCC - nessun hover effect
    toggleButton.style.cssText = `
        margin-left: 10px;
        padding: 8px 16px;
        background-color: rgb(7, 115, 152);
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-family: 'Amazon Ember', sans-serif;
        font-size: 14px;
        font-weight: 500;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    `;

 // âœ… AGGIUNGI GLI EFFETTI HOVER IDENTICI AL SCC
    toggleButton.addEventListener('mouseover', () => {
        if (!toggleButton.classList.contains('searching') && !toggleButton.classList.contains('completed')) {
            toggleButton.style.backgroundColor = 'rgba(55, 71, 90, 0.8)'; // <-- Colore richiesto!
        }
    });

    toggleButton.addEventListener('mouseout', () => {
        if (!toggleButton.classList.contains('searching') && !toggleButton.classList.contains('completed')) {
            toggleButton.style.backgroundColor = 'rgb(7, 115, 152)';
        }
    });

    return toggleButton;
}

function createTitleBar() {
    const titleBar = document.createElement('div');
    titleBar.id = 'fdpsDragHandle';

    // âœ… Get DS name from configuration
    const dsName = CURRENT_DS_CONFIG ? CURRENT_DS_CONFIG.ds_info.name : 'DS';

    titleBar.innerHTML = `
        <div style="display: flex; align-items: center; margin-right: auto;">
            <img src="https://i.postimg.cc/1zjS2CL9/L-EU-PEX2.png" style="height: 30px; width: auto; margin-right: 8px;" />
            <span>FDPS Info Sender - ${dsName}</span>
        </div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <span style="color: white; font-size: 11px; opacity: 0.8;">v${SCRIPT_VERSION}</span>
            <button id="configButton" style="background: none; border: none; color: white !important; cursor: pointer; font-size: 14px; padding: 0 5px; filter: brightness(0) invert(1); -webkit-filter: brightness(0) invert(1);" title="DS Configuration">âš™ï¸</button>
            <button id="minimizeButton" style="background: none; border: none; color: white !important; cursor: pointer; font-size: 16px; padding: 0 5px; filter: brightness(0) invert(1); -webkit-filter: brightness(0) invert(1);">âž–</button>
        </div>
    `;

    titleBar.style.cssText = `
        padding: 10px;
        background: rgb(7, 115, 152);
        color: white;
        cursor: move;
        user-select: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
        font-weight: bold;
    `;

    return titleBar;
}


function createFileUploadSection() {
    // âœ… Dynamic Mercury URL from configuration
    const mercuryUrl = CURRENT_DS_CONFIG?.ds_info?.mercury_url ||
        "https://c3.amazon.com/eu/mercury_amzl/#/dashboard/elasticsearch/1b04fe6a-751e-323f-b7b7-f45413ed2daa";

    return `
        <div style="margin-bottom: 20px;">
            <h4 style="margin: 0 0 20px 0; color: #333; font-size: 16px;">ðŸ“‹ FDPS Analysis Wizard</h4>

            <div style="margin-bottom: 20px; padding: 15px; border: 2px solid #e3f2fd; border-radius: 8px; background: #f8f9fa;">
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <div style="width: 30px; height: 30px; background: rgb(7, 115, 152); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 12px;">1</div>
                    <h5 style="margin: 0; color: #333; font-size: 14px; font-weight: 600;">Import Abandon & Customer Returns</h5>
                </div>
                <div style="margin-left: 42px; margin-bottom: 12px;">
                    <a href="${mercuryUrl}" target="_blank" style="color: rgb(7, 115, 152); text-decoration: none; font-size: 12px; font-weight: 500;">ðŸ”— Mercury AMZL Dashboard â†’</a>
                </div>
                <div style="margin-left: 42px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555; font-size: 13px;">ðŸ“‹ Pickups File</label>
                    <input type="file" id="filePickups" accept=".csv" style="width: 100%; padding: 8px; border: 2px dashed #ccc; border-radius: 5px; cursor: pointer; background: #fafafa; transition: all 0.3s ease; font-size: 12px;">
                    <div id="pickupsStatus" style="margin-top: 5px; font-size: 11px; color: #666;">No file selected</div>
                </div>
            </div>

            <div style="margin-bottom: 15px; padding: 15px; border: 2px solid #e3f2fd; border-radius: 8px; background: #f8f9fa;">
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <div style="width: 30px; height: 30px; background: rgb(7, 115, 152); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 12px;">2</div>
                    <h5 style="margin: 0; color: #333; font-size: 14px; font-weight: 600;">Import Addresses GCRS</h5>
                </div>
                <div style="margin-left: 42px; margin-bottom: 12px;">
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 8px;">
                        <a href="https://siw-eu-dub.dub.proxy.amazon.com/query" target="_blank" style="color: rgb(7, 115, 152); text-decoration: none; font-size: 12px; font-weight: 500;">ðŸ”— GCRS Query Tool â†’</a>
                        <button id="copyRelatedIds" style="padding: 4px 8px; background: rgb(17, 213, 103); color: white; border: none; border-radius: 3px; font-size: 11px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; display: none;" title="Copy Related Delivery IDs for GCRS paste">ðŸ“‹ Copy Related IDs</button>
                    </div>
                    <div style="font-size: 11px; color: #666; font-style: italic;">Use the copy button above to get Related IDs for GCRS query</div>
                </div>
                <div style="margin-left: 42px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555; font-size: 13px;">ðŸ  Addresses File</label>
                    <input type="file" id="fileAddresses" accept=".csv" style="width: 100%; padding: 8px; border: 2px dashed #ccc; border-radius: 5px; cursor: pointer; background: #fafafa; transition: all 0.3s ease; font-size: 12px;">
                    <div id="addressesStatus" style="margin-top: 5px; font-size: 11px; color: #666;">No file selected</div>
                </div>
            </div>
        </div>
    `;
}


function createActionButtons() {
    return `
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <button id="processButton" style="flex: 1; padding: 10px 16px; background-color: rgb(7, 115, 152); color: white; border: none; border-radius: 3px; font-family: 'Amazon Ember', sans-serif; font-weight: 500; cursor: pointer; transition: background-color 0.2s; opacity: 0.5; cursor: not-allowed;">ðŸš€ Start Analysis</button>
            <button id="clearAllButton" style="flex: 1; padding: 10px 16px; background-color: #666; color: white; border: none; border-radius: 3px; font-family: 'Amazon Ember', sans-serif; font-weight: 500; cursor: pointer; transition: background-color 0.2s;">ðŸ—‘ï¸ Clear All</button>
        </div>
    `;
}

function createProgressIndicator() {
    return `
        <div id="progressContainer" style="display: none; margin-bottom: 15px; background: #f5f5f5; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span style="color: #666; font-size: 14px;">Analyzing API data...</span>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span id="apiTimer" style="color: #666; font-size: 14px;">Time: 00:00</span>
                    <span id="progressText" style="color: rgb(7, 115, 152); font-weight: bold;">0%</span>
                </div>
            </div>
            <div style="background-color: #e0e0e0; height: 6px; border-radius: 3px; overflow: hidden;">
                <div id="progressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, rgb(7, 115, 152), rgb(17, 213, 103)); transition: width 0.3s ease-in-out;"></div>
            </div>
        </div>
    `;
}

function createDataView() {
    return `
        <div id="data-view" style="display: none; margin-top: 20px;">
            <h3 style="color: #333; margin-bottom: 15px;">ðŸ“Š FDPS Analysis - Address, Route Assignment & Pickup Days</h3>

            <div style="margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 5px;">
                <input type="text" id="global-filter" placeholder="ðŸ” Search all fields..." style="width: 300px; padding: 8px; border: 1px solid #ccc; border-radius: 3px; margin-right: 10px;">
                <button id="clearFiltersBtn" style="padding: 8px 15px; background: #ff6b6b; color: white; border: none; border-radius: 3px; cursor: pointer;">Clear Filters</button>
            </div>

            <div style="overflow-x: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <table id="main-table" style="width: 100%; border-collapse: collapse; font-size: 12px; background: white;">
                    <thead style="background: #555; color: white; position: sticky; top: 0;">
                        <tr>
                            ${createTableHeader('Tracking ID', 0)}
                            ${createTableHeader('Related Delivery', 1)}
                            ${createTableHeader('DSP', 2)}
                            ${createTableHeader('Route', 3)}
                            ${createTableHeader('Transporter ID', 4)}
                            ${createTableHeader('Pick up Type', 5, 'select', ['All', 'LOCKER', 'HUB/COUNTER'])}
                            ${createTableHeader('Complete Address', 6, 'input', null, 'min-width: 250px;')}
                            ${createTableHeader('PickUp Days', 7)}
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>

            <div style="margin-top: 15px; padding: 10px; background: #e8f4f8; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <span id="row-count">Total rows: 0</span> |
                    <span id="filtered-count">Displayed rows: 0</span>
                </div>
                <button id="exportButton" style="padding: 8px 16px; background-color: rgb(17, 213, 103) !important; color: white !important; border: none !important; border-radius: 3px !important; font-family: 'Amazon Ember', sans-serif !important; font-weight: 500 !important; cursor: pointer !important; transition: background-color 0.2s !important; display: none !important; visibility: visible !important; opacity: 1 !important; position: relative !important; z-index: 9999 !important;">ðŸ“¤ Export to CSV</button>
            </div>

            <div id="dsp-communication-center" style="display: none; margin-top: 25px;">
                <h3 style="color: #333; margin-bottom: 15px;">ðŸ“§ DSP Communication Center</h3>
                <div id="dsp-cards-container"></div>
            </div>
        </div>
    `;
}

function createTableHeader(title, column, type = 'input', options = null, extraStyle = '') {
    const filterElement = type === 'select' && options
        ? `<select class="column-filter" data-column="${column}" style="width: 100%; padding: 4px; font-size: 11px; border: none; border-radius: 3px;">${options.map(opt => `<option value="${opt === 'All' ? '' : opt}">${opt}</option>`).join('')}</select>`
        : `<input type="text" class="column-filter" data-column="${column}" placeholder="Filter..." style="width: 100%; padding: 4px; font-size: 11px; border: none; border-radius: 3px;">`;

    return `
        <th class="sortable" data-column="${column}" style="padding: 12px 8px; border: 1px solid #444; cursor: pointer; ${extraStyle}">
            ${title} <span class="sort-indicator">â†•ï¸</span>
            <div style="margin-top: 5px;">${filterElement}</div>
        </th>
    `;
}

function createPreviewModal() {
    const modal = document.createElement('div');
    modal.id = 'communication-preview-modal';
    modal.style.cssText = `
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 99999;
        padding: 20px;
        box-sizing: border-box;
        overflow-y: auto;
    `;

    modal.innerHTML = `
        <div id="modal-dialog" style="width: 90%; max-width: 1000px; min-height: 300px; background: white; border-radius: 8px; box-shadow: 0 4px 24px rgba(0,0,0,0.3); overflow: hidden; display: flex; flex-direction: column; animation: modalFadeIn 0.3s ease; margin: 0 auto;">
            <div style="padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; border-radius: 8px 8px 0 0; flex-shrink: 0;">
                <h3 style="margin: 0; color: #333;" id="modal-title">Communication Preview</h3>
                <button id="close-modal" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s;" title="Close preview">Ã—</button>
            </div>
            <div style="padding: 20px; flex: 1; overflow-y: auto; max-height: calc(90vh - 140px);">
                <div id="modal-content"></div>
            </div>
            <div style="padding: 20px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; background: #f8f9fa; border-radius: 0 0 8px 8px; flex-shrink: 0;">
                <button id="cancel-send" style="padding: 10px 20px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.2s;">Cancel</button>
                <button id="confirm-send" style="padding: 10px 20px; background: rgb(7, 115, 152); color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.2s;">Send</button>
            </div>
        </div>
    `;

    return modal;
}

function createScrollTopButton(container) {
    const scrollTopButton = document.createElement('button');
    scrollTopButton.id = 'fdpsScrollTopButton';
    scrollTopButton.innerHTML = 'â†‘';
    scrollTopButton.style.cssText = `
        position: sticky;
        bottom: 20px;
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background-color: rgba(7, 115, 152, 0.4);
        color: white;
        border: none;
        cursor: pointer;
        display: none;
        opacity: 0;
        transition: all 0.3s ease;
        z-index: 10000;
        font-size: 24px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        margin: 0 auto;
        transform: translateY(-50px);
    `;

 // Add hover effects
    scrollTopButton.addEventListener('mouseover', () => {
        scrollTopButton.style.backgroundColor = 'rgba(55, 71, 90, 0.8)';
        scrollTopButton.style.transform = 'translateY(-50px) scale(1.1)';
    });

    scrollTopButton.addEventListener('mouseout', () => {
        scrollTopButton.style.backgroundColor = 'rgba(7, 115, 152, 0.4)';
        scrollTopButton.style.transform = 'translateY(-50px) scale(1)';
    });

    // Scroll to top functionality
    scrollTopButton.addEventListener('click', () => {
        container.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // Show/hide button based on scroll
    container.addEventListener('scroll', () => {
        if (container.scrollTop > 300) {
            scrollTopButton.style.display = 'block';
            requestAnimationFrame(() => {
                scrollTopButton.style.opacity = '1';
            });
        } else {
            scrollTopButton.style.opacity = '0';
            setTimeout(() => {
                scrollTopButton.style.display = 'none';
            }, 300);
        }
    });

    return scrollTopButton;
}

console.log('[FDPS] END SECTION 3: UI elements creation');



// ================================================================================================
// SECTION 4: MAIN UI ASSEMBLY
// ================================================================================================

console.log('[FDPS] START SECTION 4: Main UI assembly');

function createUI() {
    const container = document.createElement('div');
    container.id = 'fdpsContainer';

    // Create title bar
    const titleBar = createTitleBar();

    // Add minimize button functionality
    const minimizeButton = titleBar.querySelector('#minimizeButton');
    minimizeButton.onclick = () => container.style.display = 'none';

    // Container styling
    container.style.cssText = `
        position: fixed;
        top: 50px;
        right: 10px;
        width: auto;
        min-width: 1200px;
        max-width: 95vw;
        background: white;
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        z-index: 9999;
        display: none;
        max-height: 90vh;
        overflow-y: auto;
        font-family: "Amazon Ember", "Amazon Ember Arabic", Arial, sans-serif;
        box-shadow: 0 4px 24px rgba(0,0,0,0.15);
        transition: all 0.3s ease;
        backdrop-filter: blur(5px);
        background-color: rgba(255, 255, 255, 0.98);
    `;

    // Create content container
    const contentContainer = document.createElement('div');
    contentContainer.style.padding = '20px';
    contentContainer.innerHTML =
        createFileUploadSection() +
        createActionButtons() +
        createProgressIndicator() +
        createDataView();

    // âœ… CREA IL SCROLL-TO-TOP BUTTON
    const scrollTopButton = createScrollTopButton(container);

    // Assemble the container
    container.appendChild(titleBar);
    container.appendChild(contentContainer);
    container.appendChild(scrollTopButton); // âœ… AGGIUNGI IL PULSANTE SCROLL

    // âœ… CREA E AGGIUNGI IL MODAL SEPARATAMENTE A DOCUMENT.BODY
    const modal = createPreviewModal();
    document.body.appendChild(modal);

    return container;
}

console.log('[FDPS] END SECTION 4: Main UI assembly');


// ================================================================================================
// SECTION 5: UI EVENT HANDLING
// ================================================================================================

console.log('[FDPS] START SECTION 5: UI event handling');

function setupUIEventListeners(container) {
    setTimeout(() => {
        const filePickups = container.querySelector('#filePickups');
        const fileAddresses = container.querySelector('#fileAddresses');
        const processButton = container.querySelector('#processButton');
        const clearAllButton = container.querySelector('#clearAllButton');
        const copyRelatedIds = container.querySelector('#copyRelatedIds');
        const pickupsStatus = container.querySelector('#pickupsStatus');
        const addressesStatus = container.querySelector('#addressesStatus');

        // âœ… Configuration button handler
        const configButton = container.querySelector('#configButton');
        if (configButton) {
            configButton.addEventListener('click', () => {
                debugLog('Configuration button clicked');
                showConfigurationModal();
            });
        }

        // File upload handlers
        filePickups.addEventListener('change', (e) => handleFileUpload(e, 'pickups'));
        fileAddresses.addEventListener('change', (e) => handleFileUpload(e, 'addresses'));

        // Process button handler - gestione intelligente degli stati
        processButton.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (processButton.disabled) {
                debugLog('Process button is disabled, ignoring click');
                return;
            }
            if (processButton.classList.contains('completed')) {
                debugLog('Process button in completed state - executing scroll to DSP center');
                scrollToDSPCenter();
                return;
            }
            debugLog('Process button clicked - starting analysis');
            startAnalysis();
        });

        clearAllButton.addEventListener('click', clearAll);
        copyRelatedIds.addEventListener('click', copyRelatedIdsToClipboard);

        updateProcessButtonState();

        function handleFileUpload(event, type) {
            const file = event.target.files[0];
            const statusDiv = type === 'pickups' ? pickupsStatus : addressesStatus;

            if (!file) {
                statusDiv.textContent = 'No file selected';
                statusDiv.style.color = '#666';
                if (type === 'pickups') {
                    scriptState.currentData.pickups = [];
                    copyRelatedIds.style.display = 'none';
                } else {
                    scriptState.currentData.addresses = [];
                }
                updateProcessButtonState();
                return;
            }

            statusDiv.textContent = 'ðŸ“ Loading...';
            statusDiv.style.color = '#ffa500';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvText = e.target.result;
                    const parsedData = parseCSV(csvText);
                    if (parsedData.length === 0) {
                        throw new Error('Empty CSV file');
                    }

                    if (type === 'pickups') {
                        const validation = validateCSVStructure(parsedData, ['Related Delivery']);
                        if (!validation.valid) {
                            throw new Error(validation.error);
                        }

                        scriptState.currentData.pickups = parsedData;
                        const notLinkedCount = calculateNotLinkedCount(parsedData);
                        scriptState.notLinkedCount = notLinkedCount;

                        statusDiv.innerHTML = `
                            âœ… ${parsedData.length - 1} rows loaded<br>
                            <span style="color: #ff6b35; font-weight: 500; font-size: 10px;">
                                ðŸ“‹ ${notLinkedCount} Not linked Tracking Id detected
                            </span>
                        `;
                        copyRelatedIds.style.display = 'inline-block';
                    } else {
                        const validation = validateCSVStructure(parsedData, ['Query_Item']);
                        if (!validation.valid) {
                            throw new Error(validation.error);
                        }

                        scriptState.currentData.addresses = parsedData;
                        statusDiv.textContent = `âœ… ${parsedData.length - 1} addresses loaded`;
                    }

                    statusDiv.style.color = '#28a745';
                    updateProcessButtonState();

                } catch (error) {
                    statusDiv.textContent = `âŒ Error: ${error.message}`;
                    statusDiv.style.color = '#dc3545';
                    debugLog(`Upload error ${type}: ${error.message}`);
                }
            };

            reader.readAsText(file);
        }

        function calculateNotLinkedCount(pickupsData) {
            if (!pickupsData || pickupsData.length === 0) return 0;

            const headers = pickupsData[0];
            const trackingIdIndex = headers.indexOf('trackingId');
            const relatedDeliveryIndex = headers.indexOf('Related Delivery');

            if (trackingIdIndex === -1 || relatedDeliveryIndex === -1) return 0;

            let notLinkedCount = 0;
            for (let i = 1; i < pickupsData.length; i++) {
                const row = pickupsData[i];
                const trackingId = row[trackingIdIndex];
                const relatedDelivery = row[relatedDeliveryIndex];

                if (trackingId && relatedDelivery && trackingId === relatedDelivery) {
                    notLinkedCount++;
                }
            }

            debugLog(`Calculated ${notLinkedCount} not linked tracking IDs immediately after upload`);
            return notLinkedCount;
        }

        function updateProcessButtonState() {
            const hasPickups = scriptState.currentData.pickups.length > 0;
            const hasAddresses = scriptState.currentData.addresses.length > 0;
            const canProcess = hasPickups && hasAddresses && !scriptState.processing;

            if (canProcess) {
                setProcessButtonState('ready');
            } else {
                setProcessButtonState('disabled');
            }
        }

        function copyRelatedIdsToClipboard() {
            if (!scriptState.currentData.pickups || scriptState.currentData.pickups.length === 0) {
                alert('No pickup data loaded');
                return;
            }

            try {
                const pickups = scriptState.currentData.pickups;
                const pickupsHeaders = pickups[0];
                const trackingIdIndex = pickupsHeaders.indexOf('trackingId');
                const relatedDeliveryIndex = pickupsHeaders.indexOf('Related Delivery');

                if (trackingIdIndex === -1 || relatedDeliveryIndex === -1) {
                    throw new Error('Required columns not found');
                }

                const validRelatedIds = [];
                for (let i = 1; i < pickups.length; i++) {
                    const row = pickups[i];
                    const trackingId = row[trackingIdIndex];
                    const relatedDelivery = row[relatedDeliveryIndex];

                    if (trackingId && relatedDelivery && trackingId !== relatedDelivery && relatedDelivery.trim()) {
                        validRelatedIds.push(relatedDelivery.trim());
                    }
                }

                const uniqueValidIds = [...new Set(validRelatedIds)].sort();
                const textToCopy = uniqueValidIds.join('\n');

                navigator.clipboard.writeText(textToCopy).then(() => {
                    const originalText = copyRelatedIds.textContent;
                    const originalBg = copyRelatedIds.style.backgroundColor;

                    copyRelatedIds.textContent = `âœ… Copied ${uniqueValidIds.length} Valid IDs!`;
                    copyRelatedIds.style.backgroundColor = '#28a745';

                    setTimeout(() => {
                        copyRelatedIds.textContent = originalText;
                        copyRelatedIds.style.backgroundColor = originalBg;
                    }, 2000);

                    debugLog(`Copied ${uniqueValidIds.length} unique VALID Related IDs to clipboard (filtered out ${scriptState.notLinkedCount} not-linked)`);
                }).catch(() => {
                    alert('Failed to copy to clipboard. Please try again.');
                });

            } catch (error) {
                alert(`Error copying Related IDs: ${error.message}`);
                debugLog(`Copy error: ${error.message}`);
            }
        }

        window.updateProcessButtonState = updateProcessButtonState;

        setTimeout(() => {
            let modal = document.getElementById('communication-preview-modal');
            if (!modal) {
                debugLog('Creating missing preview modal');
                modal = createPreviewModal();
                document.body.appendChild(modal);
                setupPreviewModal();
            }
        }, 500);

    }, 100);
}

// âœ… Configuration Modal Function - VERSIONE COMPLETA
function showConfigurationModal() {
    // Remove existing modal if present
    const existingModal = document.getElementById('fdps-config-modal');
    if (existingModal) {
        existingModal.remove();
    }

    const modal = document.createElement('div');
    modal.id = 'fdps-config-modal';
    modal.style.cssText = `
        display: flex;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 100000;
        padding: 20px;
        box-sizing: border-box;
        align-items: center;
        justify-content: center;
        overflow-y: auto;
    `;

    modal.innerHTML = `
        <div id="config-dialog" style="
            width: 95%;
            max-width: 900px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            max-height: 95vh;
        ">
            <div style="
                padding: 20px;
                border-bottom: 1px solid #eee;
                display: flex;
                justify-content: space-between;
                align-items: center;
                background: rgb(7, 115, 152);
                color: white;
            ">
                <h3 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    âš™ï¸ DS Configuration - ${CURRENT_DS_CONFIG.ds_info.name}
                </h3>
                <button id="close-config-modal" style="
                    background: none;
                    border: none;
                    font-size: 24px;
                    cursor: pointer;
                    color: white;
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: background-color 0.2s;
                " title="Close">Ã—</button>
            </div>

            <div style="padding: 20px; flex: 1; overflow-y: auto;">
                <!-- DS Info Section -->
                <div style="margin-bottom: 25px; padding: 15px; border: 2px solid #e3f2fd; border-radius: 8px; background: #f8f9fa;">
                    <h4 style="margin: 0 0 15px 0; color: #333; display: flex; align-items: center; gap: 8px;">
                        ðŸ¢ Delivery Station Information
                    </h4>
                    <div style="display: grid; grid-template-columns: 0.5fr 3fr; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555; font-size: 13px;">DS Name</label>
                            <input type="text" id="config-ds-name" value="${CURRENT_DS_CONFIG.ds_info.name}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555; font-size: 13px;">Mercury Dashboard URL</label>
                            <input type="url" id="config-mercury-url" value="${CURRENT_DS_CONFIG.ds_info.mercury_url}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                        </div>
                    </div>
                </div>

                <!-- DSP Configuration Section -->
                <div style="margin-bottom: 25px; padding: 15px; border: 2px solid #fff3e0; border-radius: 8px; background: #fffef7;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="margin: 0; color: #333; display: flex; align-items: center; gap: 8px;">
                            ðŸšš DSP Configuration (${CURRENT_DS_CONFIG.dsps.length} DSPs)
                        </h4>
                        <button id="add-dsp-btn" style="
                            padding: 8px 16px;
                            background: rgb(17, 213, 103);
                            color: white;
                            border: none;
                            border-radius: 4px;
                            font-size: 12px;
                            cursor: pointer;
                            transition: all 0.2s;
                            font-weight: 500;
                        ">+ Add New DSP</button>
                    </div>
                    <div id="dsp-list" style="max-height: 400px; overflow-y: auto;">
                        ${generateDSPConfigHTML()}
                    </div>
                </div>

                <!-- Import/Export Section -->
                <div style="margin-bottom: 15px; padding: 15px; border: 2px solid #e8f5e8; border-radius: 8px; background: #f9fff9;">
                    <h4 style="margin: 0 0 15px 0; color: #333; display: flex; align-items: center; gap: 8px;">
                        ðŸ“ Import/Export Configuration
                    </h4>
                    <div style="display: flex; gap: 10px;">
                        <input type="file" id="import-config-file" accept=".json" style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                        <button id="import-config-btn" style="padding: 8px 16px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">ðŸ“¤ Import</button>
                        <button id="export-config-btn" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">ðŸ“¥ Export</button>
                    </div>
                </div>
            </div>

            <div style="
                padding: 20px;
                border-top: 1px solid #eee;
                display: flex;
                justify-content: space-between;
                gap: 10px;
                background: #f8f9fa;
            ">
                <div>
                    <button id="reset-config-btn" style="
                        padding: 10px 20px;
                        background: #dc3545;
                        color: white;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                        transition: all 0.2s;
                    ">Reset to DLZ3</button>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button id="cancel-config-btn" style="
                        padding: 10px 20px;
                        background: #666;
                        color: white;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                        transition: all 0.2s;
                    ">Cancel</button>
                    <button id="save-config-btn" style="
                        padding: 10px 20px;
                        background: rgb(7, 115, 152);
                        color: white;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                        transition: all 0.2s;
                    ">Save Configuration</button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    setupConfigurationModalEvents(modal);
    debugLog('Configuration modal displayed');
}

// âœ… GENERAZIONE HTML DSP COMPLETA
function generateDSPConfigHTML() {
    if (!CURRENT_DS_CONFIG.dsps || CURRENT_DS_CONFIG.dsps.length === 0) {
        return '<div style="text-align: center; color: #666; padding: 20px;">No DSPs configured yet. Click "Add New DSP" to get started.</div>';
    }

    return CURRENT_DS_CONFIG.dsps.map((dsp, index) => `
        <div class="dsp-config-item" data-index="${index}" style="
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h5 style="margin: 0; display: flex; align-items: center; gap: 8px;">
                    <span style="
                        width: 18px;
                        height: 18px;
                        background: ${dsp.color_hex};
                        border-radius: 50%;
                        display: inline-block;
                        border: 2px solid #fff;
                        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
                    "></span>
                    <span style="font-weight: 600; color: #333;">${dsp.code}</span>
                    <span style="color: #666;">-</span>
                    <span style="color: #666;">${dsp.name}</span>
                </h5>
                <div style="display: flex; gap: 5px;">
                    <button class="edit-dsp-btn" data-index="${index}" style="
                        background: #ffc107;
                        color: #212529;
                        border: none;
                        border-radius: 3px;
                        padding: 4px 8px;
                        font-size: 11px;
                        cursor: pointer;
                        font-weight: 500;
                    ">Edit</button>
                    <button class="remove-dsp-btn" data-index="${index}" style="
                        background: #dc3545;
                        color: white;
                        border: none;
                        border-radius: 3px;
                        padding: 4px 8px;
                        font-size: 11px;
                        cursor: pointer;
                    ">Remove</button>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 12px; color: #666;">
                <div>
                    <strong style="color: #333;">ðŸ“§ Emails:</strong> ${dsp.emails.length} recipients<br>
                    <div style="font-size: 10px; margin-top: 2px; max-height: 40px; overflow-y: auto;">
                        ${dsp.emails.map(email => `â€¢ ${email}`).join('<br>')}
                    </div>
                </div>
                <div>
                    <strong style="color: #333;">ðŸ’¬ Chime:</strong> ${dsp.chime_webhook_url ? 'âœ… Configured' : 'âŒ Not configured'}<br>
                    ${dsp.chime_webhook_url ? '<div style="font-size: 10px; margin-top: 2px; color: #28a745;">Webhook ready</div>' : '<div style="font-size: 10px; margin-top: 2px; color: #dc3545;">No webhook URL</div>'}
                </div>
            </div>
        </div>
    `).join('');
}

// âœ… EVENTI MODAL CONFIGURAZIONE COMPLETI
function setupConfigurationModalEvents(modal) {
    const closeBtn = modal.querySelector('#close-config-modal');
    const cancelBtn = modal.querySelector('#cancel-config-btn');
    const saveBtn = modal.querySelector('#save-config-btn');
    const resetBtn = modal.querySelector('#reset-config-btn');
    const addDspBtn = modal.querySelector('#add-dsp-btn');
    const importBtn = modal.querySelector('#import-config-btn');
    const exportBtn = modal.querySelector('#export-config-btn');

    const closeModal = () => {
        modal.remove();
    };

    // Close handlers
    closeBtn.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);

    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.parentNode) {
            closeModal();
        }
    });

    // Save configuration
    saveBtn.addEventListener('click', () => {
        const dsName = modal.querySelector('#config-ds-name').value.trim();
        const mercuryUrl = modal.querySelector('#config-mercury-url').value.trim();

        if (!dsName) {
            alert('DS Name is required');
            return;
        }

        // Update configuration
        const updatedConfig = {
            ...CURRENT_DS_CONFIG,
            ds_info: {
                ...CURRENT_DS_CONFIG.ds_info,
                name: dsName,
                mercury_url: mercuryUrl
            }
        };

        if (saveDSConfiguration(updatedConfig)) {
            debugLog(`Configuration saved successfully: ${dsName}`);

            // Update DSP_CONFIG for backward compatibility
            DSP_CONFIG.dsps = CURRENT_DS_CONFIG.dsps;

            // Update title bar
            const titleBar = document.querySelector('#fdpsDragHandle span');
            if (titleBar) {
                titleBar.textContent = `FDPS Info Sender - ${dsName}`;
            }

            alert(`Configuration saved successfully!\n\nDS Name: ${dsName}\nDSP Count: ${CURRENT_DS_CONFIG.dsps.length}`);
            closeModal();
        } else {
            alert('Error saving configuration. Please try again.');
        }
    });

    // Reset to DLZ3
    resetBtn.addEventListener('click', () => {
        if (confirm('Are you sure you want to reset to default DLZ3 configuration?\n\nThis will overwrite all current settings including all DSPs.')) {
            if (saveDSConfiguration(DLZ3_CONFIG)) {
                alert('Configuration reset to DLZ3 defaults.');
                closeModal();
                // Update title bar immediately
                const titleBar = document.querySelector('#fdpsDragHandle span');
                if (titleBar) {
                    titleBar.textContent = `FDPS Info Sender - DLZ3`;
                }
                // Refresh the modal with new data
                setTimeout(() => showConfigurationModal(), 100);
            } else {
                alert('Error resetting configuration.');
            }
        }
    });

    // Add New DSP
    addDspBtn.addEventListener('click', () => {
        showDSPEditModal();
    });

    // Edit DSP buttons
    modal.addEventListener('click', (e) => {
        if (e.target.classList.contains('edit-dsp-btn')) {
            const index = parseInt(e.target.dataset.index);
            showDSPEditModal(index);
        }

        if (e.target.classList.contains('remove-dsp-btn')) {
            const index = parseInt(e.target.dataset.index);
            const dsp = CURRENT_DS_CONFIG.dsps[index];

            if (confirm(`Remove DSP "${dsp.code} - ${dsp.name}"?\n\nThis action cannot be undone.`)) {
                CURRENT_DS_CONFIG.dsps.splice(index, 1);

                // Save immediately
                saveDSConfiguration(CURRENT_DS_CONFIG);

                // Refresh DSP list
                const dspList = modal.querySelector('#dsp-list');
                dspList.innerHTML = generateDSPConfigHTML();

                // Update header count
                const headerTitle = modal.querySelector('h4');
                if (headerTitle && headerTitle.textContent.includes('DSP Configuration')) {
                    headerTitle.innerHTML = `ðŸšš DSP Configuration (${CURRENT_DS_CONFIG.dsps.length} DSPs)`;
                }

                debugLog(`Removed DSP: ${dsp.code}`);
            }
        }
    });

    // Import configuration
    importBtn.addEventListener('click', () => {
        const fileInput = modal.querySelector('#import-config-file');
        const file = fileInput.files[0];

        if (!file) {
            alert('Please select a configuration file to import.');
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedConfig = JSON.parse(e.target.result);

                // Validate configuration structure
                if (!importedConfig.ds_info || !importedConfig.dsps) {
                    throw new Error('Invalid configuration format');
                }

                if (confirm(`Import configuration?\n\nDS: ${importedConfig.ds_info.name}\nDSPs: ${importedConfig.dsps.length}\n\nThis will replace your current configuration.`)) {
                    if (saveDSConfiguration(importedConfig)) {
                        alert(`Configuration imported successfully!\n\nDS: ${importedConfig.ds_info.name}\nDSPs: ${importedConfig.dsps.length}`);
                        closeModal();
                        // Update title bar
                        const titleBar = document.querySelector('#fdpsDragHandle span');
                        if (titleBar) {
                            titleBar.textContent = `FDPS Info Sender - ${importedConfig.ds_info.name}`;
                        }
                    } else {
                        alert('Error saving imported configuration.');
                    }
                }
            } catch (error) {
                alert(`Error importing configuration: ${error.message}`);
            }
        };
        reader.readAsText(file);
    });

    // Export configuration
    exportBtn.addEventListener('click', () => {
        try {
            const configToExport = {
                ...CURRENT_DS_CONFIG,
                exported_at: new Date().toISOString(),
                exported_by: 'FDPS_Info_Sender_v' + SCRIPT_VERSION
            };

            const blob = new Blob([JSON.stringify(configToExport, null, 2)], {
                type: 'application/json;charset=utf-8'
            });

            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
            link.download = `FDPS_Config_${CURRENT_DS_CONFIG.ds_info.name}_${timestamp}.json`;

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            debugLog(`Configuration exported: ${link.download}`);

            // Visual feedback
            const originalText = exportBtn.textContent;
            exportBtn.textContent = 'âœ… Exported!';
            exportBtn.style.background = '#20c997';
            setTimeout(() => {
                exportBtn.textContent = originalText;
                exportBtn.style.background = '#28a745';
            }, 2000);

        } catch (error) {
            alert(`Export error: ${error.message}`);
        }
    });
}

// âœ… DSP EDIT MODAL COMPLETO
function showDSPEditModal(editIndex = null) {
    const isEdit = editIndex !== null;
    const dspData = isEdit ? CURRENT_DS_CONFIG.dsps[editIndex] : null;

    // Remove existing DSP edit modal
    const existingModal = document.getElementById('fdps-dsp-edit-modal');
    if (existingModal) {
        existingModal.remove();
    }

    const modal = document.createElement('div');
    modal.id = 'fdps-dsp-edit-modal';
    modal.style.cssText = `
        display: flex;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.9);
        z-index: 100001;
        padding: 20px;
        box-sizing: border-box;
        align-items: center;
        justify-content: center;
        overflow-y: auto;
    `;

    // Predefined colors
    const colorOptions = [
        { name: 'Blue', hex: '#2b77d5' },
        { name: 'Yellow', hex: '#ffff00' },
        { name: 'Orange', hex: '#ff8040' },
        { name: 'Black', hex: '#000000' },
        { name: 'Green', hex: '#008000' },
        { name: 'Red', hex: '#dc3545' },
        { name: 'Purple', hex: '#6f42c1' },
        { name: 'Teal', hex: '#20c997' },
        { name: 'Brown', hex: '#795548' },
        { name: 'Pink', hex: '#e91e63' }
    ];

    const colorOptionsHTML = colorOptions.map(color => `
        <option value="${color.hex}" ${dspData && dspData.color_hex === color.hex ? 'selected' : ''}>${color.name} (${color.hex})</option>
    `).join('');

    modal.innerHTML = `
        <div style="
            width: 90%;
            max-width: 600px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 6px 30px rgba(0,0,0,0.4);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        ">
            <div style="
                padding: 20px;
                border-bottom: 1px solid #eee;
                display: flex;
                justify-content: space-between;
                align-items: center;
                background: ${isEdit ? '#ffc107' : 'rgb(17, 213, 103)'};
                color: ${isEdit ? '#212529' : 'white'};
            ">
                <h3 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    ${isEdit ? 'âœï¸ Edit DSP' : 'âž• Add New DSP'} ${isEdit ? `- ${dspData.code}` : ''}
                </h3>
                <button id="close-dsp-modal" style="
                    background: none;
                    border: none;
                    font-size: 24px;
                    cursor: pointer;
                    color: ${isEdit ? '#212529' : 'white'};
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: background-color 0.2s;
                " title="Close">Ã—</button>
            </div>

            <div style="padding: 20px; flex: 1; overflow-y: auto;">
                <!-- Basic Info -->
                <div style="margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #333; border-bottom: 2px solid #eee; padding-bottom: 8px;">
                        ðŸ“ Basic Information
                    </h4>
                    <div style="display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555; font-size: 13px;">DSP Code *</label>
                            <input type="text" id="dsp-code" value="${dspData ? dspData.code : ''}" placeholder="e.g., HDS" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; text-transform: uppercase;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555; font-size: 13px;">DSP Name *</label>
                            <input type="text" id="dsp-name" value="${dspData ? dspData.name : ''}" placeholder="e.g., Global One" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555; font-size: 13px;">Color</label>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <select id="dsp-color" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                                    ${colorOptionsHTML}
                                </select>
                                <div id="color-preview" style="
                                    width: 30px;
                                    height: 30px;
                                    border-radius: 50%;
                                    border: 2px solid #ddd;
                                    background: ${dspData ? dspData.color_hex : '#2b77d5'};
                                "></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Email Configuration -->
                <div style="margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #333; border-bottom: 2px solid #eee; padding-bottom: 8px;">
                        ðŸ“§ Email Configuration
                    </h4>
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555; font-size: 13px;">Email Recipients (one per line) *</label>
                        <textarea id="dsp-emails" placeholder="email1@example.com&#10;email2@example.com&#10;management@amazon.com" style="
                            width: 100%;
                            height: 120px;
                            padding: 8px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            font-size: 12px;
                            font-family: monospace;
                            resize: vertical;
                            box-sizing: border-box;
                        ">${dspData ? dspData.emails.join('\n') : ''}</textarea>
                        <div style="font-size: 11px; color: #666; margin-top: 5px;">
                            ðŸ“ Add one email per line. Empty lines will be ignored.
                        </div>
                    </div>
                </div>

                <!-- Chime Configuration -->
                <div style="margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #333; border-bottom: 2px solid #eee; padding-bottom: 8px;">
                        ðŸ’¬ Chime Webhook Configuration
                    </h4>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555; font-size: 13px;">Chime Webhook URL</label>
                        <textarea id="dsp-chime-webhook" placeholder="https://hooks.chime.aws/incomingwebhooks/..." style="
                            width: 100%;
                            height: 80px;
                            padding: 8px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            font-size: 11px;
                            font-family: monospace;
                            resize: vertical;
                            box-sizing: border-box;
                        ">${dspData ? dspData.chime_webhook_url : ''}</textarea>
                        <div style="font-size: 11px; color: #666; margin-top: 5px;">
                            ðŸ”— Optional: Leave empty if no Chime integration needed
                        </div>
                    </div>
                </div>

                <!-- Validation Preview -->
                <div id="dsp-validation" style="
                    margin-top: 20px;
                    padding: 12px;
                    border-radius: 6px;
                    font-size: 12px;
                    display: none;
                "></div>
            </div>

            <div style="
                padding: 20px;
                border-top: 1px solid #eee;
                display: flex;
                justify-content: flex-end;
                gap: 10px;
                background: #f8f9fa;
            ">
                <button id="cancel-dsp-btn" style="
                    padding: 10px 20px;
                    background: #666;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    transition: all 0.2s;
                ">Cancel</button>
                <button id="save-dsp-btn" style="
                    padding: 10px 20px;
                    background: ${isEdit ? '#ffc107' : 'rgb(17, 213, 103)'};
                    color: ${isEdit ? '#212529' : 'white'};
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-weight: 600;
                ">${isEdit ? 'ðŸ’¾ Update DSP' : 'âž• Add DSP'}</button>
            </div>
        </div>
    `;

    document.body.appendChild(modal);

    // Setup DSP modal events
    setupDSPEditModalEvents(modal, editIndex);

    debugLog(`DSP ${isEdit ? 'Edit' : 'Add'} modal displayed`);
}

// âœ… EVENTI DSP EDIT MODAL
function setupDSPEditModalEvents(modal, editIndex) {
    const closeBtn = modal.querySelector('#close-dsp-modal');
    const cancelBtn = modal.querySelector('#cancel-dsp-btn');
    const saveBtn = modal.querySelector('#save-dsp-btn');
    const colorSelect = modal.querySelector('#dsp-color');
    const colorPreview = modal.querySelector('#color-preview');
    const codeInput = modal.querySelector('#dsp-code');
    const nameInput = modal.querySelector('#dsp-name');
    const emailsInput = modal.querySelector('#dsp-emails');
    const webhookInput = modal.querySelector('#dsp-chime-webhook');
    const validationDiv = modal.querySelector('#dsp-validation');

    const closeModal = () => {
        modal.remove();
    };

    // Close handlers
    closeBtn.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);

    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });

    // Color preview update
    colorSelect.addEventListener('change', () => {
        colorPreview.style.background = colorSelect.value;
    });

    // Real-time validation
    const validateForm = () => {
        const code = codeInput.value.trim().toUpperCase();
        const name = nameInput.value.trim();
        const emailsText = emailsInput.value.trim();

        let isValid = true;
        let messages = [];

        // Validate code
        if (!code) {
            isValid = false;
            messages.push('âŒ DSP Code is required');
        } else if (code.length > 10) {
            isValid = false;
            messages.push('âŒ DSP Code too long (max 10 characters)');
        } else {
            // Check for duplicate code (except when editing same DSP)
            const existingIndex = CURRENT_DS_CONFIG.dsps.findIndex(d => d.code === code);
            if (existingIndex !== -1 && existingIndex !== editIndex) {
                isValid = false;
                messages.push(`âŒ DSP Code "${code}" already exists`);
            } else {
                messages.push(`âœ… DSP Code "${code}" is valid`);
            }
        }

        // Validate name
        if (!name) {
            isValid = false;
            messages.push('âŒ DSP Name is required');
        } else {
            messages.push(`âœ… DSP Name "${name}" is valid`);
        }

        // Validate emails
        if (!emailsText) {
            isValid = false;
            messages.push('âŒ At least one email is required');
        } else {
            const emails = emailsText.split('\n').map(e => e.trim()).filter(e => e);
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const invalidEmails = emails.filter(email => !emailRegex.test(email));

            if (invalidEmails.length > 0) {
                isValid = false;
                messages.push(`âŒ Invalid emails: ${invalidEmails.join(', ')}`);
            } else {
                messages.push(`âœ… ${emails.length} valid email${emails.length > 1 ? 's' : ''}`);
            }
        }

        // Update validation display
        if (messages.length > 0) {
            validationDiv.style.display = 'block';
            validationDiv.style.background = isValid ? '#e8f5e8' : '#fff5f5';
            validationDiv.style.border = `1px solid ${isValid ? '#28a745' : '#dc3545'}`;
            validationDiv.style.color = isValid ? '#155724' : '#721c24';
            validationDiv.innerHTML = messages.join('<br>');
        } else {
            validationDiv.style.display = 'none';
        }

        // Update save button
        saveBtn.disabled = !isValid;
        saveBtn.style.opacity = isValid ? '1' : '0.5';
        saveBtn.style.cursor = isValid ? 'pointer' : 'not-allowed';

        return isValid;
    };

    // Add validation listeners
    [codeInput, nameInput, emailsInput].forEach(input => {
        input.addEventListener('input', validateForm);
        input.addEventListener('blur', validateForm);
    });

    // Initial validation
    setTimeout(validateForm, 100);

    // Save DSP
    saveBtn.addEventListener('click', () => {
        if (!validateForm()) {
            alert('Please fix the validation errors before saving.');
            return;
        }

        const code = codeInput.value.trim().toUpperCase();
        const name = nameInput.value.trim();
        const colorHex = colorSelect.value;
        const emails = emailsInput.value.split('\n').map(e => e.trim()).filter(e => e);
        const webhookUrl = webhookInput.value.trim();

        const newDSP = {
            code: code,
            name: name,
            color_hex: colorHex,
            emails: emails,
            chime_webhook_url: webhookUrl
        };

        try {
            if (editIndex !== null) {
                // Edit existing DSP
                CURRENT_DS_CONFIG.dsps[editIndex] = newDSP;
                debugLog(`Updated DSP: ${code}`);
            } else {
                // Add new DSP
                CURRENT_DS_CONFIG.dsps.push(newDSP);
                debugLog(`Added new DSP: ${code}`);
            }

            // Save configuration
            if (saveDSConfiguration(CURRENT_DS_CONFIG)) {
                alert(`DSP ${isEdit ? 'updated' : 'added'} successfully!\n\nCode: ${code}\nName: ${name}\nEmails: ${emails.length}`);

                closeModal();

                // Refresh main config modal if it exists
                const mainModal = document.getElementById('fdps-config-modal');
                if (mainModal) {
                    const dspList = mainModal.querySelector('#dsp-list');
                    const headerTitle = mainModal.querySelector('h4');

                    if (dspList) {
                        dspList.innerHTML = generateDSPConfigHTML();
                    }

                    if (headerTitle && headerTitle.textContent.includes('DSP Configuration')) {
                        headerTitle.innerHTML = `ðŸšš DSP Configuration (${CURRENT_DS_CONFIG.dsps.length} DSPs)`;
                    }
                }

            } else {
                alert('Error saving DSP configuration.');
            }
        } catch (error) {
            alert(`Error ${isEdit ? 'updating' : 'adding'} DSP: ${error.message}`);
        }
    });
}


function clearAll() {
    debugLog('Clearing all data and UI');

    setToggleButtonState('idle');
    setProcessButtonState('disabled');

    if (window.fdpsAbortController) {
        window.fdpsAbortController.abort();
        window.fdpsAbortController = null;
    }

    const filePickups = document.getElementById('filePickups');
    const fileAddresses = document.getElementById('fileAddresses');
    if (filePickups) filePickups.value = '';
    if (fileAddresses) fileAddresses.value = '';

    const copyRelatedIds = document.getElementById('copyRelatedIds');
    if (copyRelatedIds) copyRelatedIds.style.display = 'none';

    const pickupsStatus = document.getElementById('pickupsStatus');
    const addressesStatus = document.getElementById('addressesStatus');
    if (pickupsStatus) {
        pickupsStatus.textContent = 'No file selected';
        pickupsStatus.style.color = '#666';
    }
    if (addressesStatus) {
        addressesStatus.textContent = 'No file selected';
        addressesStatus.style.color = '#666';
    }

    scriptState.currentData = {
        pickups: [],
        addresses: [],
        processedResults: []
    };
    scriptState.processing = false;
    scriptState.notLinkedCount = 0;

    const dataView = document.getElementById('data-view');
    if (dataView) dataView.style.display = 'none';

    const tableBody = document.getElementById('table-body');
    if (tableBody) tableBody.innerHTML = '';

    const progressContainer = document.getElementById('progressContainer');
    if (progressContainer) progressContainer.style.display = 'none';

    const dspGuidance = document.getElementById('fdps-dsp-guidance');
    if (dspGuidance) dspGuidance.remove();

    if (window.updateProcessButtonState) {
        window.updateProcessButtonState();
    }

    debugLog('Clear completed');
}

window.showEmailPreview = function(dspCode, data, dspConfig, event) {
    const modal = document.getElementById('communication-preview-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalContent = document.getElementById('modal-content');

    if (!modal || !modalTitle || !modalContent) {
        debugLog('Modal elements not found');
        alert('Preview not available. Please try reloading the page.');
        return;
    }

    modal.setAttribute('data-mode', 'email');
    modal.setAttribute('data-dsp', dspCode);
    modalTitle.textContent = `Email Preview - ${dspConfig.name}`;

    const today = new Date().toLocaleDateString('en-GB');
    const timestamp = new Date().toLocaleString('en-GB');

    const subject = COMMUNICATION_TEMPLATES.email.subject
        .replace('{DSP_CODE}', dspCode)
        .replace('{DATE}', today);

    const header = COMMUNICATION_TEMPLATES.email.header
        .replace('{DSP_NAME}', dspConfig.name)
        .replace('{TOTAL_PICKUPS}', data.totalPickups)
        .replace('{CRITICAL_PICKUPS}', data.criticalPickups);

    const footer = COMMUNICATION_TEMPLATES.email.footer
        .replace('{SCRIPT_VERSION}', SCRIPT_VERSION)
        .replace('{TIMESTAMP}', timestamp);

    const emailTableHTML = generateHTMLEmailTable(data.records);

    modalContent.innerHTML = `
        <div style="font-family: Arial, sans-serif;">
            <div style="margin-bottom: 20px; padding: 15px; background: #f0f8ff; border-radius: 5px; border-left: 4px solid #0078d4;">
                <div style="margin-bottom: 8px;">
                    <strong style="color: #495057;">To:</strong>
                    <span style="color: #6c757d;">${dspConfig.emails.join('; ')}</span>
                </div>
                <div>
                    <strong style="color: #495057;">Subject:</strong>
                    <span style="color: #6c757d;">${subject}</span>
                </div>
            </div>

            <div style="white-space: pre-line; margin-bottom: 20px; background: #ffffff; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef; line-height: 1.6; color: #495057;">
                ${header}
            </div>

            <div style="background: #ffffff; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef; overflow-x: auto; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="margin: 0; color: #495057; border-bottom: 2px solid #e9ecef; padding-bottom: 8px; flex: 1;">
                        ðŸ“‹ Data Table:
                    </h4>
                    <button id="copy-html-table" style="padding: 10px 18px; background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; border-radius: 5px; font-weight: 600; cursor: pointer; font-size: 13px; box-shadow: 0 3px 8px rgba(40, 167, 69, 0.3); transition: all 0.2s ease; margin-left: 15px;">
                        ðŸ“‹ Copy Table (HTML Format)
                    </button>
                </div>
                <div id="copyable-table-container">
                    ${emailTableHTML}
                </div>
            </div>

            <div style="white-space: pre-line; margin-top: 20px; font-size: 13px; color: #6c757d; background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #6c757d;">
                ${footer}
            </div>

            <div style="margin-top: 15px; padding: 12px; background: #e8f4fd; border-radius: 5px; border-left: 4px solid #1976d2; font-size: 12px;">
                <strong>ðŸ’¡ How to use:</strong><br>
                1. Click "Copy Table (HTML Format)" to copy the table with formatting<br>
                2. Use the regular "Send" button to open your email client<br>
                3. Paste (Ctrl+V) in the email body - the table will keep its formatting!<br>
                <em>Note: Works best with modern email clients like Outlook, Gmail, etc.</em>
            </div>
        </div>
    `;

    setTimeout(() => {
        const copyButton = document.getElementById('copy-html-table');
        const tableContainer = document.getElementById('copyable-table-container');

        if (copyButton && tableContainer) {
            copyButton.addEventListener('click', async () => {
                try {
                    if (navigator.clipboard && navigator.clipboard.write) {
                        const htmlContent = tableContainer.innerHTML;
                        const clipboardItem = new ClipboardItem({
                            'text/html': new Blob([htmlContent], { type: 'text/html' }),
                            'text/plain': new Blob([extractTextFromHTML(htmlContent)], { type: 'text/plain' })
                        });

                        await navigator.clipboard.write([clipboardItem]);
                        showCopySuccess('Table copied with formatting!');
                        debugLog('HTML table copied with modern clipboard API');
                    } else {
                        await copyTableViaSelection(tableContainer);
                        showCopySuccess('Table copied!');
                        debugLog('HTML table copied via selection method');
                    }
                } catch (error) {
                    debugLog('Copy methods failed, showing manual selection guidance');
                    showManualCopyGuidance(tableContainer);
                }

                function showCopySuccess(message) {
                    const originalText = copyButton.textContent;
                    const originalStyle = copyButton.style.background;

                    copyButton.textContent = `âœ… ${message}`;
                    copyButton.style.background = 'linear-gradient(135deg, #17a2b8, #138496)';

                    setTimeout(() => {
                        copyButton.textContent = originalText;
                        copyButton.style.background = originalStyle;
                    }, 3000);
                }

                function showManualCopyGuidance(container) {
                    container.style.border = '3px solid #ff6b35';
                    container.style.borderRadius = '5px';
                    container.style.backgroundColor = '#fff3e0';

                    alert('ðŸ“‹ Manual Copy Instructions:\n\n1. The table is now highlighted\n2. Click and drag to select the entire table\n3. Press Ctrl+C (or Cmd+C on Mac)\n4. Paste in your email client\n\nThis will preserve the table formatting!');

                    setTimeout(() => {
                        container.style.border = '';
                        container.style.borderRadius = '';
                        container.style.backgroundColor = '';
                    }, 10000);
                }
            });

            async function copyTableViaSelection(container) {
                const range = document.createRange();
                range.selectNodeContents(container);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);

                const success = document.execCommand('copy');
                selection.removeAllRanges();

                if (!success) {
                    throw new Error('execCommand copy failed');
                }
            }

            function extractTextFromHTML(html) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                return tempDiv.textContent || tempDiv.innerText || '';
            }

            copyButton.addEventListener('mouseover', () => {
                copyButton.style.transform = 'scale(1.05)';
                copyButton.style.boxShadow = '0 5px 12px rgba(40, 167, 69, 0.4)';
            });

            copyButton.addEventListener('mouseout', () => {
                copyButton.style.transform = 'scale(1)';
                copyButton.style.boxShadow = '0 3px 8px rgba(40, 167, 69, 0.3)';
            });
        }
    }, 100);

    if (window.positionModalNearButton) {
        window.positionModalNearButton(event.target, modal);
    }

    modal.style.display = 'flex';
    debugLog('Email preview modal shown with HTML table copy functionality');
};

window.showChimePreview = function(dspCode, data, dspConfig, event) {
    const modal = document.getElementById('communication-preview-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalContent = document.getElementById('modal-content');

    if (!modal || !modalTitle || !modalContent) {
        debugLog('Modal elements not found');
        alert('Preview not available. Please try reloading the page.');
        return;
    }

    modal.setAttribute('data-mode', 'chime');
    modal.setAttribute('data-dsp', dspCode);
    modalTitle.textContent = `Chime Preview - ${dspConfig.name} (Editable)`;

    const today = new Date().toLocaleDateString('en-GB');
    const criticalCount = data.records.filter(r => r.fdpsDays === 1).length;
    const criticalRecords = data.records.filter(record => record.fdpsDays === 1);

    let tableData = '';
    if (criticalRecords.length > 0) {
        tableData = generateCompactCriticalList(criticalRecords);
    }

    const initialChimeMessage = `/md ðŸš¨ **FDPS Alert - ${dspCode}**

ðŸ“Š ðŸ“… Date: ${today} - âš ï¸ **${criticalCount} First Routed Critical Pick Up:**

${criticalCount > 0 ? `${tableData}` : 'âœ… **No critical items today** - All pickups have more than 1 day'}

ðŸ”— Complete and Detailed report sent via email`;

    modalContent.innerHTML = `
        <div style="font-family: Arial, sans-serif;">
            <div style="margin-bottom: 20px; padding: 10px; background: #fff3cd; border-radius: 5px; border-left: 4px solid #ff6b35;">
                <strong>ðŸ”— Chime Webhook URL:</strong><br>
                <code style="font-size: 11px; word-break: break-all;">${dspConfig.chime_webhook_url}</code>
            </div>

            <div style="margin-bottom: 15px; padding: 10px; background: #e8f4fd; border-radius: 5px; border-left: 4px solid #1976d2;">
                <strong>ðŸ’¡ Markdown Enabled:</strong> Message starts with <code>/md</code> for proper Chime formatting (tables, bold, etc.)
            </div>

            ${criticalCount > 0 ? `
                <div style="margin-bottom: 15px; padding: 10px; background: #fff5f5; border-radius: 5px; border-left: 4px solid #dc3545;">
                    <strong>ðŸš¨ Critical Focus:</strong> This message shows only <strong>${criticalCount} critical items (1 day)</strong> grouped by route/address. Non-critical items are excluded from Chime but included in the email.
                </div>
            ` : `
                <div style="margin-bottom: 15px; padding: 10px; background: #e8f5e8; border-radius: 5px; border-left: 4px solid #28a745;">
                    <strong>âœ… Good News:</strong> No critical items found! All ${data.totalPickups} pickups have more than 1 day.
                </div>
            `}

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057; font-size: 14px;">
                    ðŸ“ Edit Chime Message:
                </label>
                <textarea id="chime-message-editor" style="width: 100%; height: 400px; padding: 15px; border: 1px solid #dee2e6; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 11px; line-height: 1.3; resize: vertical; background: #f8f9fa; color: #495057; box-sizing: border-box;" placeholder="Edit your Chime message here...">${initialChimeMessage}</textarea>
            </div>

            <div id="chime-stats" style="padding: 10px; border-radius: 4px; font-size: 11px; display: flex; justify-content: space-between; align-items: center; background: #e3f2fd; color: #1565c0; border: 1px solid #2196f3;">
                <span>ðŸ“Š Characters: <strong id="char-count">${initialChimeMessage.length}</strong> / 4000</span>
                <span>ðŸ”´ Critical Only: <strong>${criticalCount}</strong></span>
                <span>ðŸ“¦ Total Pickups: <strong>${data.totalPickups}</strong></span>
            </div>
        </div>
    `;

    setTimeout(() => {
        const editor = document.getElementById('chime-message-editor');
        const charCount = document.getElementById('char-count');
        const statsDiv = document.getElementById('chime-stats');

        if (editor && charCount && statsDiv) {
            const updateStats = () => {
                const length = editor.value.length;
                charCount.textContent = length;

                if (length > 4000) {
                    charCount.style.color = '#d32f2f';
                    statsDiv.style.backgroundColor = '#ffebee';
                    statsDiv.style.color = '#c62828';
                    statsDiv.style.border = '1px solid #f44336';
                } else if (length > 3500) {
                    charCount.style.color = '#f57c00';
                    statsDiv.style.backgroundColor = '#fff3e0';
                    statsDiv.style.color = '#ef6c00';
                    statsDiv.style.border = '1px solid #ff9800';
                } else {
                    charCount.style.color = '#1565c0';
                    statsDiv.style.backgroundColor = '#e3f2fd';
                    statsDiv.style.color = '#1565c0';
                    statsDiv.style.border = '1px solid #2196f3';
                }
            };

            editor.addEventListener('input', updateStats);
            editor.addEventListener('paste', () => setTimeout(updateStats, 10));
            editor.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'a') {
                    e.preventDefault();
                    editor.select();
                }
                if (e.key === 'Tab') {
                    e.preventDefault();
                    const start = editor.selectionStart;
                    const end = editor.selectionEnd;
                    editor.value = editor.value.substring(0, start) + "  " + editor.value.substring(end);
                    editor.selectionStart = editor.selectionEnd = start + 2;
                    updateStats();
                }
            });

            updateStats();
        }
    }, 100);

    if (window.positionModalNearButton) {
        window.positionModalNearButton(event.target, modal);
    }

    modal.style.display = 'flex';
    debugLog('Chime preview modal shown with ultra-compact format');
};

function generateCompactCriticalList(criticalRecords) {
    if (!criticalRecords || criticalRecords.length === 0) return '';

    const addressGroups = {};
    criticalRecords.forEach(record => {
        const route = record.routeCode || '-';
        const address = record.address;
        const type = record.pickupType === 'HUB/COUNTER' ? 'HUB' : 'LOCKER';
        const key = `${route}_${address}_${type}`;

        if (!addressGroups[key]) {
            addressGroups[key] = {
                route,
                type,
                address,
                count: 0
            };
        }
        addressGroups[key].count++;
    });

    let tableData = 'Route | PickUp | Type | Address\n';
    tableData += '------|-------|------|--------\n';

    const sortedGroups = Object.values(addressGroups).sort((a, b) => {
        if (a.route !== b.route) return a.route.localeCompare(b.route);
        return a.address.localeCompare(b.address);
    });

    sortedGroups.forEach(group => {
        tableData += `**${group.route}** | **${group.count}** | ${group.type} | ${group.address}\n`;
    });

    return tableData;
}

window.positionModalNearButton = function(buttonElement, modal) {
    const buttonRect = buttonElement.getBoundingClientRect();
    const viewport = {
        width: window.innerWidth,
        height: window.innerHeight,
        scrollY: window.scrollY,
        scrollX: window.scrollX
    };

    const modalDialog = modal.querySelector('#modal-dialog');
    if (!modalDialog) {
        debugLog('Modal dialog not found - using full modal positioning');
        modal.style.cssText = `
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 99999;
            padding: 20px;
            box-sizing: border-box;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
        `;
        return;
    }

    const modalWidth = Math.min(viewport.width * 0.9, 1000);
    const modalHeight = Math.min(viewport.height * 0.8, 700);

    let top = buttonRect.bottom + 20 + viewport.scrollY;
    let left = Math.max(20, Math.min(
        buttonRect.left + viewport.scrollX - (modalWidth / 2) + (buttonRect.width / 2),
        viewport.width - modalWidth - 20
    ));

    if (top + modalHeight > viewport.height + viewport.scrollY - 20) {
        top = buttonRect.top + viewport.scrollY - modalHeight - 20;
        if (top < viewport.scrollY + 20) {
            top = viewport.scrollY + (viewport.height - modalHeight) / 2;
        }
    }

    modal.style.cssText = `
        display: flex;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 99999;
        padding: 0;
        margin: 0;
        box-sizing: border-box;
        align-items: flex-start;
        justify-content: flex-start;
        overflow-y: auto;
    `;

    modalDialog.style.cssText = `
        position: absolute;
        top: ${top - viewport.scrollY}px;
        left: ${left - viewport.scrollX}px;
        width: ${modalWidth}px;
        max-height: ${modalHeight}px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 24px rgba(0,0,0,0.3);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        z-index: 100000;
    `;

    debugLog(`Modal positioned: top=${top}px, left=${left}px`);
};

window.executeSendEmail = function(dspCode) {
    const results = scriptState.currentData.processedResults;
    if (!results || results.length === 0) {
        alert('No data available to send');
        return;
    }

    const dspData = aggregateDataByDSP(results);
    const data = dspData[dspCode];
    const dspConfig = DSP_CONFIG.dsps.find(d => d.code === dspCode);

    if (!data || !dspConfig) {
        alert('Error: DSP data not found');
        return;
    }

    const today = new Date().toLocaleDateString('en-GB');
    const timestamp = new Date().toLocaleString('en-GB');

    const subject = COMMUNICATION_TEMPLATES.email.subject
        .replace('{DSP_CODE}', dspCode)
        .replace('{DATE}', today);

    const header = COMMUNICATION_TEMPLATES.email.header
        .replace('{DSP_NAME}', dspConfig.name)
        .replace('{TOTAL_PICKUPS}', data.totalPickups)
        .replace('{CRITICAL_PICKUPS}', data.criticalPickups);

    const footer = COMMUNICATION_TEMPLATES.email.footer
        .replace('{SCRIPT_VERSION}', SCRIPT_VERSION)
        .replace('{TIMESTAMP}', timestamp);

    const fullEmailTable = generateSimplifiedEmailTable(data.records);
    const fullEmailBody = `${header}\n\n${fullEmailTable}\n\n${footer}`;

    const recipients = dspConfig.emails.join(';');
    const totalLength = subject.length + fullEmailBody.length + recipients.length + 200;

    debugLog(`mailto total length: ${totalLength} characters for ${data.totalPickups} pickups`);

    let finalEmailBody;
    let isReduced = false;

    if (totalLength > 20000) {
        debugLog(`Email too long (${totalLength} chars), using compact version`);
        isReduced = true;

        const criticalCount = data.records.filter(r => r.fdpsDays === 1).length;
        const criticalItems = data.records.filter(r => r.fdpsDays === 1);

        const compactHeader = `Dear ${dspConfig.name} Team,\n\n` +
            `FDPS Analysis Summary - ${today}:\n` +
            `â€¢ Total Pickups: ${data.totalPickups}\n` +
            `â€¢ Critical Items (1 day): ${criticalCount}\n` +
            `â€¢ Routes: ${data.routesList.join(', ') || 'N/A'}\n` +
            `â€¢ HUB/COUNTER: ${data.hubCounterCount} | LOCKER: ${data.lockerCount}\n\n`;

        let criticalSection = '';
        if (criticalCount > 0) {
            criticalSection = `ðŸ”´ CRITICAL ITEMS (${criticalCount} - IMMEDIATE ATTENTION REQUIRED):\n`;
            criticalItems.slice(0, 20).forEach((record, index) => {
                const shortAddress = record.address.length > 40
                    ? record.address.substring(0, 37) + '...'
                    : record.address;
                criticalSection += `${index + 1}. ${record.relatedDelivery} | ${record.routeCode || '-'} | ${shortAddress}\n`;
            });
            if (criticalCount > 20) {
                criticalSection += `...and ${criticalCount - 20} more critical items\n`;
            }
            criticalSection += '\n';
        }

        const nonCriticalItems = data.records.filter(r => r.fdpsDays !== 1);
        let otherSection = '';
        if (nonCriticalItems.length > 0) {
            const routeGroups = {};
            nonCriticalItems.forEach(record => {
                const route = record.routeCode || 'NO-ROUTE';
                if (!routeGroups[route]) routeGroups[route] = 0;
                routeGroups[route]++;
            });

            otherSection = `ðŸ“¦ OTHER PICKUPS (${nonCriticalItems.length} items):\n`;
            Object.keys(routeGroups).sort().forEach(route => {
                otherSection += `${route}: ${routeGroups[route]} items\n`;
            });
            otherSection += '\n';
        }

        const compactFooter = `âš ï¸ Large dataset (${data.totalPickups} items) - Summary view\n` +
            `For complete details, please request full export via FDPS tool.\n\n` +
            `Best regards,\nAmazon Logistics Team - ${CURRENT_DS_CONFIG.ds_info.name}\n\n` +
            `Generated by FDPS Tool v${SCRIPT_VERSION} on ${timestamp}`;

        finalEmailBody = compactHeader + criticalSection + otherSection + compactFooter;

        const finalLength = subject.length + finalEmailBody.length + recipients.length + 200;
        debugLog(`Compact email length: ${finalLength} characters`);

        if (finalLength > 1900) {
            finalEmailBody = `Dear ${dspConfig.name} Team,\n\n` +
                `FDPS Alert - ${today}\n\n` +
                `ðŸ“Š Summary:\n` +
                `â€¢ Total: ${data.totalPickups} pickups\n` +
                `â€¢ Critical (1 day): ${criticalCount}\n` +
                `â€¢ Routes: ${data.routesList.length}\n\n` +
                `âš ï¸ ${criticalCount} items require IMMEDIATE attention!\n\n` +
                `Due to large dataset, please:\n` +
                `1. Use FDPS tool export for full details\n` +
                `2. Contact logistics team if needed\n\n` +
                `Critical routes: ${data.routesList.slice(0, 5).join(', ')}${data.routesList.length > 5 ? '...' : ''}\n\n` +
                `Best regards,\nAmazon Logistics - ${CURRENT_DS_CONFIG.ds_info.name}\n\n` +
                `FDPS Tool v${SCRIPT_VERSION} - ${timestamp}`;
        }
    } else {
        finalEmailBody = fullEmailBody;
    }

    const mailtoLink = `mailto:${recipients}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(finalEmailBody)}`;

    if (isReduced) {
        alert(`ðŸ“§ Email Summary Created (Large Dataset)\n\n` +
            `Original: ${data.totalPickups} pickups\n` +
            `Due to email length limits, a summary version was created.\n\n` +
            `âœ… Critical items (${data.records.filter(r => r.fdpsDays === 1).length}) are fully listed\n` +
            `ðŸ“‹ Other items grouped by route\n\n` +
            `For complete details, use the Export CSV button.`);
    }

    window.open(mailtoLink, '_blank');
    debugLog(`Email sent for DSP ${dspCode} with ${dspConfig.emails.length} recipients (reduced: ${isReduced})`);
};

window.executeSendChime = function(dspCode) {
    const results = scriptState.currentData.processedResults;
    if (!results || results.length === 0) {
        alert('No data available to send');
        return;
    }

    const dspData = aggregateDataByDSP(results);
    const data = dspData[dspCode];
    const dspConfig = DSP_CONFIG.dsps.find(d => d.code === dspCode);

    if (!data || !dspConfig) {
        alert('Error: DSP data not found');
        return;
    }

    let messageContent;
    const editor = document.getElementById('chime-message-editor');
    if (editor && editor.value.trim()) {
        messageContent = editor.value.trim();
        if (!messageContent.startsWith('/md ')) {
            messageContent = '/md ' + messageContent;
        }
        debugLog('Using edited Chime message with /md prefix');
    } else {
        const today = new Date().toLocaleDateString('en-GB');
        const criticalCount = data.records.filter(r => r.fdpsDays === 1).length;
        const criticalRecords = data.records.filter(record => record.fdpsDays === 1);

        let tableData = '';
        if (criticalRecords.length > 0) {
            tableData = generateCompactCriticalList(criticalRecords);
        }

        messageContent = `/md ðŸš¨ **FDPS Alert - ${dspCode}**

ðŸ“Š ðŸ“… Date: ${today} - âš ï¸ **${criticalCount} First Routed Critical Pick Up:**

${criticalCount > 0 ? `${tableData}` : 'âœ… **No critical items today** - All pickups have more than 1 day'}

ðŸ”— Complete and Detailed report sent via email`;

        debugLog('Using default ultra-simplified Chime template with /md prefix');
    }

    if (messageContent.length > 4000) {
        if (!confirm(`Message is ${messageContent.length} characters (limit ~4000).\n\nThis may fail to send. Continue anyway?`)) {
            return;
        }
    }

    debugLog(`Sending ultra-simplified Chime message of ${messageContent.length} characters`);

    const chimeMessage = {
        "Content": messageContent
    };

    GM_xmlhttpRequest({
        method: 'POST',
        url: dspConfig.chime_webhook_url,
        data: JSON.stringify(chimeMessage),
        headers: {
            'Content-Type': 'application/json'
        },
        onload: function(response) {
            if (response.status === 200) {
                debugLog(`Ultra-simplified Chime message sent successfully to DSP ${dspCode}`);
                alert(`Chime message sent successfully to ${dspConfig.name}!\n\nMessage length: ${messageContent.length} characters\nCritical items only: ${data.records.filter(r => r.fdpsDays === 1).length}`);
            } else {
                debugLog(`Chime webhook failed for DSP ${dspCode}: ${response.status}`);
                alert(`Failed to send Chime message to ${dspConfig.name}. Status: ${response.status}`);
            }
        },
        onerror: function(error) {
            debugLog(`Chime webhook error for DSP ${dspCode}: ${error}`);
            alert(`Error sending Chime message to ${dspCode}: ${error}`);
        }
    });
};

window.setupPreviewModal = function() {
    const modal = document.getElementById('communication-preview-modal');
    const closeBtn = document.getElementById('close-modal');
    const cancelBtn = document.getElementById('cancel-send');
    const confirmBtn = document.getElementById('confirm-send');

    if (!modal) return;

    const closeModal = () => {
        modal.style.display = 'none';
        modal.removeAttribute('data-mode');
        modal.removeAttribute('data-dsp');
    };

    closeBtn.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);

    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.style.display === 'flex') {
            closeModal();
        }
    });

    confirmBtn.addEventListener('click', () => {
        const mode = modal.getAttribute('data-mode');
        const dspCode = modal.getAttribute('data-dsp');

        if (mode === 'email' && window.executeSendEmail) {
            window.executeSendEmail(dspCode);
        } else if (mode === 'chime' && window.executeSendChime) {
            window.executeSendChime(dspCode);
        }
        closeModal();
    });
};

console.log('[FDPS] END SECTION 5: UI event handling');


// ================================================================================================
// SECTION 6: DRAG & DROP FUNCTIONALITY
// ================================================================================================

console.log('[FDPS] START SECTION 6: Drag & Drop functionality');

function setupDragFunctionality(container, titleBar) {
    let isDragging = false;
    let currentX, currentY, initialX, initialY;
    let xOffset = 0, yOffset = 0;

    function dragStart(e) {
        if (e.type === "touchstart") {
            initialX = e.touches[0].clientX - xOffset;
            initialY = e.touches[0].clientY - yOffset;
        } else {
            initialX = e.clientX - xOffset;
            initialY = e.clientY - yOffset;
        }

        if (e.target === titleBar || e.target.parentElement === titleBar) {
            isDragging = true;
        }
    }

    function dragEnd() {
        initialX = currentX;
        initialY = currentY;
        isDragging = false;
    }

    function drag(e) {
        if (isDragging) {
            e.preventDefault();

            if (e.type === "touchmove") {
                currentX = e.touches[0].clientX - initialX;
                currentY = e.touches[0].clientY - initialY;
            } else {
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;
            }

            // Add viewport boundaries
            const rect = container.getBoundingClientRect();
            const viewport = {
                width: window.innerWidth,
                height: window.innerHeight
            };

            // Horizontal limits
            if (currentX < -rect.width + 100) currentX = -rect.width + 100;
            if (currentX > viewport.width - 100) currentX = viewport.width - 100;

            // Vertical limits
            if (currentY < 0) currentY = 0;
            if (currentY > viewport.height - 100) currentY = viewport.height - 100;

            xOffset = currentX;
            yOffset = currentY;

            setTranslate(currentX, currentY, container);
        }
    }

    function setTranslate(xPos, yPos, el) {
        el.style.transform = `translate3d(${xPos}px, ${yPos}px, 0)`;
    }

    // Add event listeners for drag
    titleBar.addEventListener('mousedown', dragStart, false);
    document.addEventListener('mousemove', drag, false);
    document.addEventListener('mouseup', dragEnd, false);
    titleBar.addEventListener('touchstart', dragStart, false);
    document.addEventListener('touchmove', drag, false);
    document.addEventListener('touchend', dragEnd, false);
}

console.log('[FDPS] END SECTION 6: Drag & Drop functionality');

// ================================================================================================
// SECTION 7: TABLE FUNCTIONALITY
// ================================================================================================

console.log('[FDPS] START SECTION 7: Table functionality');

function setupTableFunctionality() {
    const table = document.getElementById('main-table');
    if (!table) return;

    let currentSort = { column: null, direction: 'asc' };

    // Cached elements
    const tbody = table.querySelector('#table-body');
    const globalFilter = document.getElementById('global-filter');
    const clearFiltersBtn = document.getElementById('clearFiltersBtn');
    const rowCount = document.getElementById('row-count');
    const filteredCount = document.getElementById('filtered-count');

    // Unified debounced filter function
    const debouncedFilter = debounce(() => applyFilters(), CONFIG.DEBOUNCE_DELAY);

    // Setup sorting
    table.querySelectorAll('.sortable').forEach(header => {
        header.addEventListener('click', (e) => {
            if (['INPUT', 'SELECT'].includes(e.target.tagName)) {
                e.stopPropagation();
                return;
            }
            sortTable(parseInt(header.dataset.column));
        });
    });

    // Setup all filters with unified handler
    table.querySelectorAll('.column-filter, .range-filter-min, .range-filter-max').forEach(filter => {
        filter.addEventListener('input', debouncedFilter);
        filter.addEventListener('change', debouncedFilter);
    });

    // Global filter
    if (globalFilter) {
        globalFilter.addEventListener('input', debouncedFilter);
    }

    // Clear filters button
    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', clearAllFilters);
    }

    function sortTable(columnIndex) {
        const rows = Array.from(tbody.querySelectorAll('tr'));

        // Update sort direction
        if (currentSort.column === columnIndex) {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.column = columnIndex;
            currentSort.direction = 'asc';
        }

        // Update indicators
        table.querySelectorAll('.sortable').forEach(header => {
            const indicator = header.querySelector('.sort-indicator');
            const isCurrentColumn = parseInt(header.dataset.column) === columnIndex;
            indicator.textContent = isCurrentColumn
                ? (currentSort.direction === 'asc' ? 'â†‘' : 'â†“')
                : 'â†•ï¸';
        });

        // Sort rows
        rows.sort((a, b) => {
            const aValue = a.cells[columnIndex].textContent.trim();
            const bValue = b.cells[columnIndex].textContent.trim();

            // Numeric sort for FDPS Days column (column 5)
            if (columnIndex === 5) {
                const aNum = parseInt(aValue) || 0;
                const bNum = parseInt(bValue) || 0;
                return currentSort.direction === 'asc' ? aNum - bNum : bNum - aNum;
            }

            // Text sort for other columns
            return currentSort.direction === 'asc'
                ? aValue.localeCompare(bValue)
                : bValue.localeCompare(aValue);
        });

        // Re-append sorted rows
        rows.forEach(row => tbody.appendChild(row));
    }

    function applyFilters() {
        const rows = tbody.querySelectorAll('tr');
        const globalFilterValue = globalFilter ? globalFilter.value.toLowerCase() : '';
        const columnFilters = table.querySelectorAll('.column-filter');
        const minFilter = table.querySelector('.range-filter-min[data-column="7"]');
        const maxFilter = table.querySelector('.range-filter-max[data-column="7"]');

        let visibleCount = 0;

        rows.forEach(row => {
            let showRow = true;

            // Global filter check
            if (globalFilterValue && !row.textContent.toLowerCase().includes(globalFilterValue)) {
                showRow = false;
            }

            // Column filters check
            if (showRow) {
                columnFilters.forEach(filter => {
                    const column = parseInt(filter.dataset.column);
                    const filterValue = filter.value.toLowerCase();

                    if (filterValue) {
                        const cellValue = row.cells[column].textContent.trim();

                        if (column === 7) {
                            // Exact match for PickUp Days
                            if (cellValue !== filter.value.trim()) {
                                showRow = false;
                            }
                        } else {
                            // Partial match for other columns
                            if (!cellValue.toLowerCase().includes(filterValue)) {
                                showRow = false;
                            }
                        }
                    }
                });
            }

            // Range filters for FDPS Days (column 7)
            if (showRow) {
                const cellValue = parseInt(row.cells[7].textContent) || 0;

                if (minFilter && minFilter.value && cellValue < parseInt(minFilter.value)) {
                    showRow = false;
                }
                if (maxFilter && maxFilter.value && cellValue > parseInt(maxFilter.value)) {
                    showRow = false;
                }
            }

            row.style.display = showRow ? '' : 'none';
            if (showRow) visibleCount++;
        });

        updateRowCounters(visibleCount, rows.length);
    }

    function clearAllFilters() {
        // Clear all filter inputs
        table.querySelectorAll('.column-filter, .range-filter-min, .range-filter-max').forEach(filter => {
            filter.value = '';
        });

        if (globalFilter) globalFilter.value = '';

        // Show all rows
        const rows = tbody.querySelectorAll('tr');
        rows.forEach(row => row.style.display = '');
        updateRowCounters(rows.length, rows.length);
    }

    function updateRowCounters(visible, total) {
        if (rowCount) rowCount.textContent = `Total rows: ${total}`;
        if (filteredCount) filteredCount.textContent = `Displayed rows: ${visible}`;
    }
}

console.log('[FDPS] END SECTION 7: Table functionality');


// ================================================================================================
// SECTION 8: STYLES AND CSS
// ================================================================================================

console.log('[FDPS] START SECTION 8: Styles and CSS');

function addCustomStyles() {
    const style = document.createElement('style');
    style.textContent = `
        /* File upload hover effects */
        #filePickups:hover, #fileAddresses:hover {
            border-color: rgb(7, 115, 152) !important;
            background: #f0f8ff !important;
        }

        /* Table styles */
        #main-table tbody tr {
            transition: background-color 0.2s ease;
        }

        #main-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        #main-table tbody tr:hover {
            background-color: #e3f2fd !important;
        }

        /* Filter input styles */
        .column-filter, .range-filter-min, .range-filter-max {
            transition: all 0.2s ease;
        }

        .column-filter:focus, .range-filter-min:focus, .range-filter-max:focus {
            background: white !important;
            box-shadow: 0 0 0 2px rgba(7, 115, 152, 0.3) !important;
            outline: none !important;
        }

        /* Button hover effects */
        #processButton:not(:disabled):hover {
            background-color: #37475A !important;
        }

        #clearAllButton:hover {
            background-color: #555 !important;
        }

        /* âœ… EXPORT BUTTON STILE SCC - VISIBILITÃ€ FORZATA */
        #exportButton {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
            z-index: 9999 !important;
            background-color: rgb(17, 213, 103) !important;
            color: white !important;
            border: none !important;
            padding: 8px 16px !important;
            border-radius: 3px !important;
            cursor: pointer !important;
            font-family: 'Amazon Ember', sans-serif !important;
            font-weight: 500 !important;
            transition: all 0.2s ease !important;
            margin-left: auto !important;
        }

        #exportButton:hover {
            background-color: #0ea5e9 !important;
            transform: scale(1.02) !important;
        }

        #exportButton:active {
            transform: scale(0.98) !important;
        }

        /* âœ… PROCESS BUTTON STATES - AGGIORNATI CON GRADIENT BACKGROUND */
        #processButton {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            border: none;
            border-radius: 3px;
        }

        #processButton.processing {
            animation: processingGlow 2s ease-in-out infinite;
        }

        #processButton.completed {
            animation: completedGlow 1.5s ease-in-out;
        }

        @keyframes processingGlow {
            0%, 100% {
                box-shadow: 0 2px 8px rgba(255, 107, 53, 0.4);
            }
            50% {
                box-shadow: 0 4px 16px rgba(255, 107, 53, 0.7);
            }
        }

        @keyframes completedGlow {
            0% {
                box-shadow: 0 2px 8px rgba(40, 167, 69, 0.4);
            }
            50% {
                box-shadow: 0 6px 20px rgba(40, 167, 69, 0.8);
            }
            100% {
                box-shadow: 0 2px 8px rgba(40, 167, 69, 0.4);
            }
        }

        /* âœ… TOGGLE BUTTON STATES - AGGIORNATI */
        #fdpsToggle {
    position: relative;
    overflow: hidden;
}

/* Loading State con effetto pulsante */
#fdpsToggle.searching {
            background: linear-gradient(45deg, #ff6b35, #f7931e, #ff6b35, #f7931e) !important;
            background-size: 400% 400% !important;
            animation: searchingGradient 2s ease infinite !important;
            box-shadow: 0 0 20px rgba(255, 107, 53, 0.5) !important;
}

#fdpsToggle.searching::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: searchingShine 3s ease-in-out infinite;
            }

/* Completed State */
#fdpsToggle.completed {
            background: linear-gradient(135deg, #11d567, #2ecc71) !important;
            box-shadow: 0 0 20px rgba(17, 213, 103, 0.5) !important;
            animation: completedPulse 2s ease infinite !important;
}


        /* Animations */
        @keyframes searchingGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes searchingShine {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        @keyframes completedPulse {
            0%, 100% {
                box-shadow: 0 0 20px rgba(17, 213, 103, 0.5);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 30px rgba(17, 213, 103, 0.8);
                transform: scale(1.02);
            }
        }

        /* âœ… UPDATE BUTTON SPIN ANIMATION */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* âœ… SCROLL TO TOP BUTTON STYLES */
        #fdpsScrollTopButton {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        #fdpsScrollTopButton:active {
            transform: translateX(-50%) scale(0.95) !important;
        }

        /* Animazione di comparsa */
        @keyframes scrollButtonFadeIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        /* Quando il pulsante appare */
        #fdpsScrollTopButton[style*="opacity: 1"] {
            animation: scrollButtonFadeIn 0.3s ease-out;
        }

        /* âœ… NUOVI STILI PER L'EDITOR CHIME */
        #chime-message-editor:focus {
            outline: none !important;
            border: 2px solid rgb(7, 115, 152) !important;
            box-shadow: 0 0 0 3px rgba(7, 115, 152, 0.1) !important;
        }

        #chime-preview {
            border: 1px solid #dee2e6;
            transition: all 0.2s ease;
        }

        /* Highlight per elementi critici nel preview */
        #chime-preview .critical-highlight {
            background-color: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
            color: #856404;
            font-weight: 600;
        }

        /* Scrollbar personalizzata per l'editor */
        #chime-message-editor::-webkit-scrollbar {
            width: 8px;
        }

        #chime-message-editor::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        #chime-message-editor::-webkit-scrollbar-thumb {
            background: rgb(7, 115, 152);
            border-radius: 4px;
        }

        #chime-message-editor::-webkit-scrollbar-thumb:hover {
            background: #37475A;
        }

        /* Animazione per il contatore caratteri */
        #char-count {
            transition: color 0.3s ease;
        }

        /* Modal fade in animation */
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* âœ… STILI SPECIFICI PER IL FOOTER DELLA TABELLA */
        .info-footer {
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            margin-top: 15px !important;
            padding: 10px !important;
            background: #e8f4f8 !important;
            border-radius: 5px !important;
        }

        .info-footer > div:first-child {
            flex: 1 !important;
        }

        .info-footer > #exportButton {
            flex-shrink: 0 !important;
            margin-left: 15px !important;
        }

        /* Responsive adjustments */
        @media (max-width: 1400px) {
            #fdpsContainer {
                min-width: 1000px;
            }

            #main-table {
                font-size: 11px;
            }

            th, td {
                padding: 8px 6px !important;
            }
        }

        /* Responsive per l'editor */
        @media (max-width: 1200px) {
            #chime-message-editor {
                height: 300px !important;
            }

            #chime-preview {
                max-height: 200px !important;
            }
        }

        /* âœ… DEBUG HELPER - EVIDENZIA IL BOTTONE EXPORT */
        #exportButton.debug-highlight {
            border: 3px solid red !important;
            animation: debugBlink 1s infinite !important;
        }

        @keyframes debugBlink {
            0%, 50% { background-color: rgb(17, 213, 103) !important; }
            51%, 100% { background-color: #ff0000 !important; }
        }

        /* âœ… LAYOUT FOOTER TABELLA MIGLIORATO */
.info-footer,
.info-footer-fixed {
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    margin-top: 15px !important;
    padding: 10px !important;
    background: #e8f4f8 !important;
    border-radius: 5px !important;
    gap: 15px !important;
}

.info-footer > div:first-child,
.info-footer-fixed > div:first-child {
    flex: 1 !important;
    display: flex !important;
    align-items: center !important;
    gap: 10px !important;
}

#exportButton {
    flex-shrink: 0 !important;
    margin-left: auto !important;
}

/* âœ… STATO FEEDBACK DEL BOTTONE EXPORT */
#exportButton:disabled {
    opacity: 0.8 !important;
    cursor: not-allowed !important;
}

    `;

    document.head.appendChild(style);
}

console.log('[FDPS] END SECTION 8: Styles and CSS');


// ================================================================================================
// SEZIONE 9: API E RICHIESTE HTTP
// ================================================================================================

console.log('[FDPS] START SECTION 9: API and HTTP requests');

function makeDriverAssignmentRequest(relatedDelivery, retryCount = 0) {
    return new Promise((resolve) => {
        // Check if aborted
        if (window.fdpsAbortController?.signal.aborted) {
            resolve({
                error: true,
                errorType: 'CANCELLED',
                message: 'Request cancelled',
                days: 0,
                routeCode: ''
            });
            return;
        }

        const currentDomain = window.location.hostname;
        const baseUrl = `https://${currentDomain}`;

        debugLog(`Making API request for ${relatedDelivery} (attempt ${retryCount + 1})`);

        // âœ… TIMEOUT INCREMENTALE: piÃ¹ tentativi = timeout maggiore
        const timeoutMs = CONFIG.REQUEST_TIMEOUT + (retryCount * 10000); // +10s per ogni retry

        const request = GM_xmlhttpRequest({
            method: 'POST',
            url: `${baseUrl}/station/proxyapigateway/data`,
            data: JSON.stringify({
                resourcePath: "/os/getPackageHistoryData",
                httpMethod: "post",
                processName: "oculus",
                requestBody: {
                    packageId: relatedDelivery,
                    pageSize: 100,
                    pageToken: null
                }
            }),
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'Origin': baseUrl,
                'Referer': `${baseUrl}/station/dashboard/search`
            },
            onload: function(response) {
                handleFDPSResponse(response, relatedDelivery, resolve, retryCount);
            },
            onerror: function(error) {
                debugLog(`API error for ${relatedDelivery} (attempt ${retryCount + 1}): ${error}`);
                // âœ… RETRY LOGIC PER ERRORI DI RETE
                if (retryCount < CONFIG.MAX_RETRIES) {
                    debugLog(`Retrying ${relatedDelivery} in ${CONFIG.RETRY_DELAY}ms...`);
                    setTimeout(() => {
                        makeDriverAssignmentRequest(relatedDelivery, retryCount + 1)
                            .then(resolve);
                    }, CONFIG.RETRY_DELAY * (retryCount + 1)); // Delay incrementale
                } else {
                    resolve({
                        error: true,
                        errorType: 'NETWORK_ERROR',
                        message: `Network error after ${CONFIG.MAX_RETRIES} retries: ${error}`,
                        days: 0,
                        routeCode: ''
                    });
                }
            },
            timeout: timeoutMs,
            ontimeout: function() {
                debugLog(`API timeout for ${relatedDelivery} (attempt ${retryCount + 1}, timeout: ${timeoutMs}ms)`);
                // âœ… RETRY LOGIC PER TIMEOUT
                if (retryCount < CONFIG.MAX_RETRIES) {
                    debugLog(`Retrying ${relatedDelivery} after timeout in ${CONFIG.RETRY_DELAY}ms...`);
                    setTimeout(() => {
                        makeDriverAssignmentRequest(relatedDelivery, retryCount + 1)
                            .then(resolve);
                    }, CONFIG.RETRY_DELAY * (retryCount + 1));
                } else {
                    resolve({
                        error: true,
                        errorType: 'TIMEOUT',
                        message: `Request timed out after ${CONFIG.MAX_RETRIES} retries (final timeout: ${timeoutMs}ms)`,
                        days: 0,
                        routeCode: ''
                    });
                }
            }
        });

        // Add abort listener
        if (window.fdpsAbortController) {
            window.fdpsAbortController.signal.addEventListener('abort', () => {
                if (request.abort) {
                    request.abort();
                }
                resolve({
                    error: true,
                    errorType: 'CANCELLED',
                    message: 'Request cancelled by user',
                    days: 0,
                    routeCode: ''
                });
            });
        }
    });
}

// âœ… NUOVA FUNZIONE PER INTERROGARE PICKUP FAILED CON TRACKING ID
function makePickupFailedRequest(trackingId, retryCount = 0) {
    return new Promise(async (resolve) => {
        // Check if aborted
        if (window.fdpsAbortController?.signal.aborted) {
            resolve({
                error: true,
                errorType: 'CANCELLED',
                message: 'Request cancelled',
                lastPickup: '',
                lastDatePickup: '',
                lastReasonPickup: ''
            });
            return;
        }

        const currentDomain = window.location.hostname;
        const baseUrl = `https://${currentDomain}`;

        debugLog(`Making Pickup Failed API request for trackingId: ${trackingId} (attempt ${retryCount + 1})`);

        try {
            const response = await fetch(`${baseUrl}/station/proxyapigateway/data`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                },
                body: JSON.stringify({
                    resourcePath: "/os/getPackageHistoryData",
                    httpMethod: "post",
                    processName: "oculus",
                    requestBody: {
                        packageId: trackingId,
                        pageSize: 100,
                        pageToken: null
                    }
                }),
                signal: window.fdpsAbortController?.signal
            });

            const text = await response.text();

            if (response.status === 404) {
                debugLog(`TrackingId ${trackingId} not found (404)`);
                resolve({
                    error: false,
                    lastPickup: '',
                    lastDatePickup: '',
                    lastReasonPickup: ''
                });
                return;
            }

            if (response.status >= 500) {
                if (retryCount < CONFIG.MAX_RETRIES) {
                    debugLog(`Server error for ${trackingId} (${response.status}), retrying...`);
                    setTimeout(() => {
                        makePickupFailedRequest(trackingId, retryCount + 1).then(resolve);
                    }, CONFIG.RETRY_DELAY * (retryCount + 1));
                    return;
                }
            }

            const data = JSON.parse(text);

            if (!data.packageHistory || !Array.isArray(data.packageHistory)) {
                debugLog(`Invalid package history data for trackingId: ${trackingId}`);
                resolve({
                    error: false,
                    lastPickup: '',
                    lastDatePickup: '',
                    lastReasonPickup: ''
                });
                return;
            }

            debugLog(`Found ${data.packageHistory.length} history events for trackingId: ${trackingId}`);

            // âœ… CERCA EVENTI "PICKUP FAILED" + "PACKAGE_STATE_UPDATE"
            const pickupFailedEvents = data.packageHistory.filter(event => {
                const isPickupFailed = event.packageState === 'PICKUP_FAILED';
                let hasPackageStateUpdate = false;
                if (Array.isArray(event.operation)) {
                    hasPackageStateUpdate = event.operation.some(op =>
                        op && op.includes('PACKAGE_STATE_UPDATE')
                    );
                } else if (typeof event.operation === 'string') {
                    hasPackageStateUpdate = event.operation.includes('PACKAGE_STATE_UPDATE');
                }
                return isPickupFailed && hasPackageStateUpdate;
            });

            debugLog(`Found ${pickupFailedEvents.length} Pickup Failed + Package State Update events for trackingId: ${trackingId}`);

            // ðŸ“… PRENDI L'EVENTO PICKUP FAILED PIÃ™ RECENTE
            let lastPickup = '';
            let lastDatePickup = '';
            let lastReasonPickup = '';

            if (pickupFailedEvents.length > 0) {
                const mostRecentEvent = pickupFailedEvents.sort((a, b) =>
                    new Date(b.stateTime) - new Date(a.stateTime)
                )[0];

                lastPickup = 'Pickup Failed';
                lastDatePickup = new Date(mostRecentEvent.stateTime).toLocaleDateString('en-GB') + ' ' +
                                new Date(mostRecentEvent.stateTime).toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit'});
                lastReasonPickup = mostRecentEvent.reasonCode || 'No reason specified';

                debugLog(`âœ… Most recent Pickup Failed event for trackingId ${trackingId}: ${lastPickup} - ${lastReasonPickup}`);
            } else {
                // âœ… FALLBACK: prendi qualsiasi PICKUP_FAILED
                const allPickupFailed = data.packageHistory.filter(event =>
                    event.packageState === 'PICKUP_FAILED'
                );

                if (allPickupFailed.length > 0) {
                    const mostRecentEvent = allPickupFailed.sort((a, b) =>
                        new Date(b.stateTime) - new Date(a.stateTime)
                    )[0];

                    lastPickup = 'Pickup Failed';
                    lastDatePickup = new Date(mostRecentEvent.stateTime).toLocaleDateString('en-GB') + ' ' +
                                    new Date(mostRecentEvent.stateTime).toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit'});
                    lastReasonPickup = mostRecentEvent.reasonCode || 'No reason specified';

                    debugLog(`âœ… Fallback Pickup Failed event for trackingId ${trackingId}: ${lastPickup} - ${lastReasonPickup}`);
                } else {
                    debugLog(`âŒ No Pickup Failed events found for trackingId: ${trackingId}`);
                }
            }

            resolve({
                error: false,
                lastPickup: lastPickup,
                lastDatePickup: lastDatePickup,
                lastReasonPickup: lastReasonPickup
            });

        } catch (error) {
            debugLog(`Error processing trackingId ${trackingId}: ${error.message} (attempt ${retryCount + 1})`);

            if (retryCount < CONFIG.MAX_RETRIES) {
                setTimeout(() => {
                    makePickupFailedRequest(trackingId, retryCount + 1).then(resolve);
                }, CONFIG.RETRY_DELAY * (retryCount + 1));
            } else {
                resolve({
                    error: true,
                    message: error.message,
                    lastPickup: '',
                    lastDatePickup: '',
                    lastReasonPickup: ''
                });
            }
        }
    });
}

function handleFDPSResponse(response, relatedDelivery, resolve, retryCount = 0) {
    try {
        debugLog(`Processing API response for ${relatedDelivery}, status: ${response.status} (attempt ${retryCount + 1})`);

        // âœ… GESTIONE MIGLIORATA DEGLI ERRORI HTTP
        if (response.status === 404) {
            debugLog(`Package ${relatedDelivery} not found (404)`);
            resolve({
                error: false, // Non Ã¨ un errore di sistema
                days: 0,
                routeCode: 'Package Not Found'
            });
            return;
        }

        if (response.status === 429) {
            debugLog(`Rate limited for ${relatedDelivery} (429)`);
            // Retry con delay maggiore per rate limiting
            if (retryCount < CONFIG.MAX_RETRIES) {
                setTimeout(() => {
                    makeDriverAssignmentRequest(relatedDelivery, retryCount + 1)
                        .then(resolve);
                }, CONFIG.RETRY_DELAY * 3); // Delay maggiore per rate limit
                return;
            }
        }

        if (response.status >= 500) {
            debugLog(`Server error for ${relatedDelivery} (${response.status})`);
            // Retry per errori server
            if (retryCount < CONFIG.MAX_RETRIES) {
                setTimeout(() => {
                    makeDriverAssignmentRequest(relatedDelivery, retryCount + 1)
                        .then(resolve);
                }, CONFIG.RETRY_DELAY * (retryCount + 1));
                return;
            }
        }

        if (!response.responseText || response.responseText.trim() === '') {
            debugLog(`Empty response for ${relatedDelivery}`);
            // âœ… RETRY PER RISPOSTE VUOTE
            if (retryCount < CONFIG.MAX_RETRIES) {
                debugLog(`Retrying ${relatedDelivery} due to empty response...`);
                setTimeout(() => {
                    makeDriverAssignmentRequest(relatedDelivery, retryCount + 1)
                        .then(resolve);
                }, CONFIG.RETRY_DELAY);
                return;
            } else {
                resolve({
                    error: false,
                    days: 0,
                    routeCode: 'Empty Response'
                });
                return;
            }
        }

        // âœ… PARSING PIÃ™ ROBUSTO
        let cleanResponse = response.responseText
            .trim()
            .replace(/^\s+|\s+$/g, '')
            .replace(/[\u0000-\u001F]/g, '')
            .replace(/\ufeff/g, '');

        let data;
        try {
            data = JSON.parse(cleanResponse);
        } catch (parseError) {
            debugLog(`JSON parse error for ${relatedDelivery}: ${parseError.message}`);
            // âœ… RETRY PER ERRORI DI PARSING
            if (retryCount < CONFIG.MAX_RETRIES) {
                setTimeout(() => {
                    makeDriverAssignmentRequest(relatedDelivery, retryCount + 1)
                        .then(resolve);
                }, CONFIG.RETRY_DELAY);
                return;
            } else {
                resolve({
                    error: true,
                    errorType: 'PARSE_ERROR',
                    message: `JSON parse error after retries: ${parseError.message}`,
                    days: 0,
                    routeCode: ''
                });
                return;
            }
        }

        if (!data.packageHistory || !Array.isArray(data.packageHistory)) {
            debugLog(`Invalid package history data for ${relatedDelivery}`);
            resolve({
                error: false, // Non Ã¨ un errore di sistema
                days: 0,
                routeCode: 'No Events Found'
            });
            return;
        }

        debugLog(`Found ${data.packageHistory.length} history events for ${relatedDelivery} (attempt ${retryCount + 1})`);

        // âœ… LOGICA FDPS - CERCA EVENTI "DELIVERED" CON "Route Assignment"
        const targetEvents = data.packageHistory.filter(event => {
            // Cerca eventi "Delivered"
            const isDelivered = event.packageState === 'DELIVERED' ||
                event.currentStatus === 'DELIVERED';

            // Cerca "Route Assignment" nell'operation
            let hasRouteAssignment = false;
            if (Array.isArray(event.operation)) {
                hasRouteAssignment = event.operation.some(op =>
                    op && (op.includes('Route Assignment') || op.includes('ROUTE_ASSIGNMENT'))
                );
            } else if (typeof event.operation === 'string') {
                hasRouteAssignment = event.operation.includes('Route Assignment') ||
                    event.operation.includes('ROUTE_ASSIGNMENT');
            }

            return isDelivered && hasRouteAssignment;
        });

        debugLog(`Found ${targetEvents.length} FDPS target events for ${relatedDelivery}`);

        if (targetEvents.length === 0) {
            // âœ… RICERCA PIÃ™ FLESSIBILE - Se non trova eventi specifici, cerca solo "DELIVERED"
            const deliveredEvents = data.packageHistory.filter(event =>
                event.packageState === 'DELIVERED' || event.currentStatus === 'DELIVERED'
            );

            debugLog(`Fallback: Found ${deliveredEvents.length} general DELIVERED events for ${relatedDelivery}`);

            if (deliveredEvents.length === 0) {
                resolve({
                    error: false,
                    days: 0,
                    routeCode: 'No Delivered Events'
                });
                return;
            }

            // Route code piÃ¹ recente
            const mostRecentDelivered = deliveredEvents.sort((a, b) =>
                new Date(b.stateTime) - new Date(a.stateTime)
            )[0];

            // Conta giorni unici
            const eventsByDate = new Set();
            deliveredEvents.forEach(event => {
                if (event.stateTime) {
                    const eventDate = new Date(event.stateTime);
                    const dateString = eventDate.toISOString().split('T')[0];
                    eventsByDate.add(dateString);
                }
            });

            const days = eventsByDate.size;
            const routeCode = mostRecentDelivered.routeCode || 'Generic Delivered';

            debugLog(`Fallback FDPS result for ${relatedDelivery}: ${days} days, route: ${routeCode}`);

            resolve({
                error: false,
                days: days,
                routeCode: routeCode
            });
            return;
        }

        // Route code piÃ¹ recente tra i target events
        const mostRecentTargetEvent = targetEvents.sort((a, b) =>
            new Date(b.stateTime) - new Date(a.stateTime)
        )[0];

        // Conta giorni unici per i target events
        const eventsByDate = new Set();
        targetEvents.forEach(event => {
            if (event.stateTime) {
                const eventDate = new Date(event.stateTime);
                const dateString = eventDate.toISOString().split('T')[0];
                eventsByDate.add(dateString);
            }
        });

        const days = eventsByDate.size;
        const routeCode = mostRecentTargetEvent.routeCode || 'No Route Code';

        debugLog(`âœ… SUCCESS - FDPS result for ${relatedDelivery}: ${days} days, route: ${routeCode} (attempt ${retryCount + 1})`);

        resolve({
            error: false,
            days: days,
            routeCode: routeCode
        });

    } catch (error) {
        debugLog(`Error parsing response for ${relatedDelivery}: ${error.message} (attempt ${retryCount + 1})`);
        // âœ… RETRY ANCHE PER ERRORI DI PROCESSING
        if (retryCount < CONFIG.MAX_RETRIES) {
            setTimeout(() => {
                makeDriverAssignmentRequest(relatedDelivery, retryCount + 1)
                    .then(resolve);
            }, CONFIG.RETRY_DELAY);
        } else {
            resolve({
                error: true,
                errorType: 'PARSE_ERROR',
                message: `Parse error after ${CONFIG.MAX_RETRIES} retries: ${error.message}`,
                days: 0,
                routeCode: ''
            });
        }
    }
}

console.log('[FDPS] END SECTION 9: API and HTTP requests');


// ================================================================================================
// SECTION 10: DATA PROCESSING
// ================================================================================================

console.log('[FDPS] START SECTION 10: Data processing');

function populateDataView(results) {
    const dataView = document.getElementById('data-view');
    const tableBody = document.getElementById('table-body');
    const exportButton = document.getElementById('exportButton');

    // âœ… DEBUG: Verifica elementi
    console.log('[FDPS DEBUG] Elements found:', {
        dataView: !!dataView,
        tableBody: !!tableBody,
        exportButton: !!exportButton
    });

    if (!dataView || !tableBody) {
        debugLog('Data view elements not found');
        return;
    }

    // Clear existing data
    tableBody.innerHTML = '';

    // Populate table
    results.forEach(record => {
        const row = document.createElement('tr');

        // âœ… PICKUP DAYS COLOR: RED IF 1, BLACK FOR OTHERS
        const pickupDaysStyle = record.fdpsDays === 1
            ? 'color: #d32f2f; font-weight: 600;'
            : 'color: #333;';

        row.innerHTML = `
            <td style="padding: 8px; border-bottom: 1px solid #eee;">
                ${record.trackingId}
            </td>
            <td style="padding: 8px; border-bottom: 1px solid #eee;">
                <a href="https://logistics.amazon.co.uk/station/dashboard/search?shareableLink=detailPage%2F${record.relatedDelivery}"
                   target="_blank"
                   style="color: rgb(7, 115, 152); text-decoration: none; font-weight: 500;">
                    ${record.relatedDelivery}
                </a>
            </td>
            <td style="padding: 8px; border-bottom: 1px solid #eee;">${record.dsp}</td>
            <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: center;">
                ${record.routeCode || '-'}
            </td>
            <td style="padding: 8px; border-bottom: 1px solid #eee;">${record.transporterId}</td>
            <td style="padding: 8px; border-bottom: 1px solid #eee;">${record.pickupType}</td>
            <td style="padding: 8px; border-bottom: 1px solid #eee; max-width: 300px; word-wrap: break-word;">${record.address}</td>
            <td style="
                padding: 8px;
                border-bottom: 1px solid #eee;
                text-align: center;
                ${pickupDaysStyle}
            ">${record.fdpsDays > 0 ? record.fdpsDays : '-'}</td>
        `;

        tableBody.appendChild(row);
    });

    // âœ… UPDATE COUNTERS
    const rowCount = document.getElementById('row-count');
    const filteredCount = document.getElementById('filtered-count');
    if (rowCount) rowCount.textContent = `Total rows: ${results.length}`;
    if (filteredCount) filteredCount.textContent = `Displayed rows: ${results.length}`;

    dataView.style.display = 'block';

    // Setup table functionality
    setupTableFunctionality();

    // âœ… SETUP DSP COMMUNICATION CENTER
    setupDSPCommunicationCenter(results);

    // âœ… CALCOLA STATS DSP PER IL BOTTONE E AGGIORNA IMMEDIATAMENTE
    const dspCount = new Set(results.map(r => r.dsp).filter(d => d)).size;
    const criticalCount = results.filter(r => r.fdpsDays === 1).length;

    // âœ… AGGIORNA IL PULSANTE CON STATS DSP USANDO setTimeout PER GARANTIRE L'APPLICAZIONE
    setTimeout(() => {
        setProcessButtonState('completed', 100, '', { dspCount, criticalCount });
        debugLog(`Process button updated to completed state with ${dspCount} DSPs and ${criticalCount} critical items`);
    }, 100);

    // âœ… SOLUZIONE DEFINITIVA PER IL BOTTONE EXPORT
    setTimeout(() => {
        console.log('[EXPORT FIX] Applying definitive export button fix...');

        // 1. Rimuovi il vecchio bottone se esiste
        const oldExportButton = document.getElementById('exportButton');
        if (oldExportButton) {
            oldExportButton.remove();
            console.log('[EXPORT FIX] Old export button removed');
        }

        // 2. Trova il footer della tabella
        let tableFooter = document.querySelector('.info-footer');
        if (!tableFooter) {
            // Se non esiste, cerchiamo il div che contiene row-count
            const rowCountDiv = document.getElementById('row-count');
            if (rowCountDiv) {
                tableFooter = rowCountDiv.parentElement;
            }
        }

        if (!tableFooter) {
            // Ultima risorsa: aggiungi dopo la tabella
            const mainTable = document.getElementById('main-table');
            if (mainTable && mainTable.parentElement) {
                tableFooter = document.createElement('div');
                tableFooter.className = 'info-footer';
                tableFooter.style.cssText = `
                    display: flex !important;
                    justify-content: space-between !important;
                    align-items: center !important;
                    margin-top: 15px !important;
                    padding: 10px !important;
                    background: #e8f4f8 !important;
                    border-radius: 5px !important;
                    gap: 15px !important;
                `;
                mainTable.parentElement.appendChild(tableFooter);

                // Aggiungi il div per i contatori se non esiste
                if (!document.getElementById('row-count')) {
                    const countersDiv = document.createElement('div');
                    countersDiv.style.cssText = `
                        flex: 1 !important;
                        display: flex !important;
                        align-items: center !important;
                        gap: 10px !important;
                    `;
                    countersDiv.innerHTML = `
                        <span id="row-count">Total rows: ${results.length}</span>
                        <span style="color: #666;">|</span>
                        <span id="filtered-count">Displayed rows: ${results.length}</span>
                    `;
                    tableFooter.appendChild(countersDiv);
                }
            }
        }

        // âœ… ASSICURATI CHE IL FOOTER ABBIA IL LAYOUT CORRETTO
        if (tableFooter && !tableFooter.classList.contains('info-footer-fixed')) {
            tableFooter.classList.add('info-footer-fixed');
            tableFooter.style.cssText = `
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                margin-top: 15px !important;
                padding: 10px !important;
                background: #e8f4f8 !important;
                border-radius: 5px !important;
                gap: 15px !important;
            `;

            // Assicurati che il div dei contatori sia a sinistra
            const countersDiv = tableFooter.querySelector('div:first-child');
            if (countersDiv) {
                countersDiv.style.cssText = `
                    flex: 1 !important;
                    display: flex !important;
                    align-items: center !important;
                    gap: 10px !important;
                `;
            }
        }

        if (tableFooter) {
            console.log('[EXPORT FIX] Table footer found/created');

            // 3. Crea il nuovo bottone export
            const newExportButton = document.createElement('button');
            newExportButton.id = 'exportButton';
            newExportButton.innerHTML = 'ðŸ“¤ Export to CSV';
            newExportButton.style.cssText = `
                padding: 8px 16px !important;
                background-color: rgb(17, 213, 103) !important;
                color: white !important;
                border: none !important;
                border-radius: 3px !important;
                font-family: 'Amazon Ember', sans-serif !important;
                font-weight: 500 !important;
                cursor: pointer !important;
                transition: all 0.2s ease !important;
                margin-left: auto !important;
                flex-shrink: 0 !important;
            `;

            // 4. Hover effects
            newExportButton.addEventListener('mouseover', () => {
                newExportButton.style.backgroundColor = '#0ea5e9';
                newExportButton.style.transform = 'scale(1.02)';
            });

            newExportButton.addEventListener('mouseout', () => {
                newExportButton.style.backgroundColor = 'rgb(17, 213, 103)';
                newExportButton.style.transform = 'scale(1)';
            });

            // 5. Click handler
            newExportButton.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('[EXPORT FIX] New export button clicked');

                try {
                    exportToCSV();
                } catch (error) {
                    console.error('[EXPORT FIX] Export error:', error);
                    alert('Export error: ' + error.message);
                }
            });

            // 6. Aggiungi al footer
            tableFooter.appendChild(newExportButton);

            console.log('[EXPORT FIX] New export button created and added to table footer');

            // 7. Verifica finale
            setTimeout(() => {
                const finalButton = document.getElementById('exportButton');
                const rect = finalButton?.getBoundingClientRect();
                console.log('[EXPORT FIX] Final verification:', {
                    exists: !!finalButton,
                    visible: rect && rect.width > 0 && rect.height > 0,
                    position: rect ? `${Math.round(rect.left)}, ${Math.round(rect.top)}` : 'N/A',
                    size: rect ? `${Math.round(rect.width)}x${Math.round(rect.height)}` : 'N/A'
                });
            }, 100);

        } else {
            console.error('[EXPORT FIX] Could not find or create table footer');

            // Piano B: bottone fisso in basso a destra
            const emergencyButton = document.createElement('button');
            emergencyButton.id = 'exportButton';
            emergencyButton.innerHTML = 'ðŸ“¤ Export CSV';
            emergencyButton.style.cssText = `
                position: fixed !important;
                bottom: 20px !important;
                right: 20px !important;
                z-index: 99999 !important;
                padding: 12px 20px !important;
                background-color: rgb(17, 213, 103) !important;
                color: white !important;
                border: none !important;
                border-radius: 5px !important;
                font-family: 'Amazon Ember', sans-serif !important;
                font-weight: 500 !important;
                cursor: pointer !important;
                box-shadow: 0 4px 12px rgba(17, 213, 103, 0.4) !important;
                transition: all 0.2s ease !important;
            `;

            emergencyButton.addEventListener('click', () => {
                try {
                    exportToCSV();
                } catch (error) {
                    alert('Export error: ' + error.message);
                }
            });

            document.body.appendChild(emergencyButton);
            console.log('[EXPORT FIX] Emergency export button added (fixed position)');
        }

    }, 200);

    debugLog(`Data view populated with ${results.length} records`);
}

// âœ… DSP COMMUNICATION FUNCTIONS
function setupDSPCommunicationCenter(results) {
    const dspCenter = document.getElementById('dsp-communication-center');
    const dspCardsContainer = document.getElementById('dsp-cards-container');

    if (!dspCenter || !dspCardsContainer) return;

    // Aggregate data by DSP
    const dspData = aggregateDataByDSP(results);

    if (Object.keys(dspData).length === 0) {
        dspCenter.style.display = 'none';
        return;
    }

    // Show DSP center
    dspCenter.style.display = 'block';

    // Clear existing cards
    dspCardsContainer.innerHTML = '';

    // Create cards for each DSP
    Object.keys(dspData).forEach(dspCode => {
        const data = dspData[dspCode];
        const dspConfig = DSP_CONFIG.dsps.find(d => d.code === dspCode);

        if (!dspConfig) {
            debugLog(`DSP configuration not found for code: ${dspCode}`);
            return;
        }

        const card = createDSPCard(dspCode, data, dspConfig);
        dspCardsContainer.appendChild(card);
    });

    // Setup modal functionality
    setupPreviewModal();

    debugLog(`DSP Communication Center setup with ${Object.keys(dspData).length} DSPs`);
}

function aggregateDataByDSP(results) {
    const dspData = {};

    results.forEach(record => {
        const dsp = record.dsp;
        if (!dsp) return;

        if (!dspData[dsp]) {
            dspData[dsp] = {
                totalPickups: 0,
                criticalPickups: 0,
                routes: new Set(),
                hubCounterCount: 0,
                lockerCount: 0,
                records: []
            };
        }

        dspData[dsp].totalPickups++;
        dspData[dsp].records.push(record);

        if (record.fdpsDays === 1) {
            dspData[dsp].criticalPickups++;
        }

        if (record.routeCode && record.routeCode !== '-') {
            dspData[dsp].routes.add(record.routeCode);
        }

        if (record.pickupType === 'HUB/COUNTER') {
            dspData[dsp].hubCounterCount++;
        } else if (record.pickupType === 'LOCKER') {
            dspData[dsp].lockerCount++;
        }
    });

    // Convert routes Set to Array and sort
    Object.keys(dspData).forEach(dsp => {
        dspData[dsp].routesList = Array.from(dspData[dsp].routes).sort();

        // Sort records by route (ascending)
        dspData[dsp].records.sort((a, b) => {
            const routeA = a.routeCode || '';
            const routeB = b.routeCode || '';
            return routeA.localeCompare(routeB);
        });
    });

    return dspData;
}

function createDSPCard(dspCode, data, dspConfig) {
    const card = document.createElement('div');
    card.style.cssText = `
        margin-bottom: 15px;
        padding: 15px;
        border: 2px solid ${dspConfig.color_hex};
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.95);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    `;

    const colorDot = `<span style="
        display: inline-block;
        width: 12px;
        height: 12px;
        background-color: ${dspConfig.color_hex};
        border-radius: 50%;
        margin-right: 8px;
        vertical-align: middle;
    "></span>`;

    card.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
            <div>
                <h4 style="margin: 0 0 8px 0; color: #333; font-size: 16px; display: flex; align-items: center;">
                    ${colorDot} ${dspCode} - ${dspConfig.name}
                </h4>
                <div style="font-size: 13px; color: #666; line-height: 1.4;">
                    <strong>${data.totalPickups}</strong> pickups â€¢
                    <strong style="color: ${data.criticalPickups > 0 ? '#d32f2f' : '#666'};">${data.criticalPickups}</strong> critical (1 day) â€¢
                    Routes: <strong>${data.routesList.length > 0 ? data.routesList.join(', ') : 'N/A'}</strong><br>
                    HUB/COUNTER: <strong>${data.hubCounterCount}</strong> â€¢
                    LOCKER: <strong>${data.lockerCount}</strong>
                </div>
            </div>
        </div>

        <div style="display: flex; gap: 10px;">
            <button class="preview-email-btn" data-dsp="${dspCode}" style="
                flex: 1;
                padding: 8px 12px;
                background: linear-gradient(135deg, #0078d4, #106ebe);
                color: white;
                border: none;
                border-radius: 4px;
                font-size: 12px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
            ">
                ðŸ“§ Preview Email (${dspConfig.emails.length} recipients)
            </button>

            <button class="preview-chime-btn" data-dsp="${dspCode}" style="
                flex: 1;
                padding: 8px 12px;
                background: linear-gradient(135deg, #ff6b35, #e85a2b);
                color: white;
                border: none;
                border-radius: 4px;
                font-size: 12px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
            ">
                ðŸ’¬ Preview Chime
            </button>
        </div>
    `;

    // âœ… USA LE FUNZIONI GLOBALI
    const emailBtn = card.querySelector('.preview-email-btn');
    const chimeBtn = card.querySelector('.preview-chime-btn');

    emailBtn.addEventListener('click', (event) => {
        if (window.showEmailPreview) {
            window.showEmailPreview(dspCode, data, dspConfig, event);
        } else {
            alert('Email preview not available');
        }
    });

    chimeBtn.addEventListener('click', (event) => {
        if (window.showChimePreview) {
            window.showChimePreview(dspCode, data, dspConfig, event);
        } else {
            alert('Chime preview not available');
        }
    });

    return card;
}

// âœ… FUNZIONE EMAIL TABLE CON GESTIONE LUNGHEZZA AUTOMATICA
function generateSimplifiedEmailTable(records) {
    if (!records || records.length === 0) {
        return 'No data available for this DSP.';
    }

    // Sort records: critical items first (days = 1), then by route
    const sortedRecords = records.sort((a, b) => {
        if (a.fdpsDays === 1 && b.fdpsDays !== 1) return -1;
        if (b.fdpsDays === 1 && a.fdpsDays !== 1) return 1;
        const routeA = a.routeCode || '';
        const routeB = b.routeCode || '';
        return routeA.localeCompare(routeB);
    });

    let table = '';

    // âœ… VERSIONE NORMALE PER DATASET PICCOLI
    if (records.length <= 300) {
        // Header normale
        table += 'â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n';
        table += 'â”‚ PickUp Daysâ”‚ Related Delivery        â”‚ Route    â”‚ Type         â”‚ Address                                            â”‚\n';
        table += 'â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\n';

        sortedRecords.forEach(record => {
            const isCritical = record.fdpsDays === 1;
            const prefix = isCritical ? 'ðŸ”´ ' : '   ';
            const days = (record.fdpsDays > 0 ? record.fdpsDays.toString() : '-').padEnd(10).substring(0, 10);
            const relatedDelivery = (prefix + record.relatedDelivery).padEnd(23).substring(0, 23);
            const route = (record.routeCode || '-').padEnd(8).substring(0, 8);
            const type = record.pickupType.padEnd(12).substring(0, 12);
            const address = record.address.padEnd(50).substring(0, 50);

            table += `â”‚ ${days} â”‚ ${relatedDelivery} â”‚ ${route} â”‚ ${type} â”‚ ${address} â”‚\n`;
        });

        table += 'â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜';
    } else {
        // âœ… VERSIONE COMPATTA PER DATASET GRANDI
        const criticalItems = sortedRecords.filter(r => r.fdpsDays === 1);
        const nonCriticalItems = sortedRecords.filter(r => r.fdpsDays !== 1);

        if (criticalItems.length > 0) {
            table += `ðŸ”´ CRITICAL ITEMS (${criticalItems.length} - 1 DAY PICKUP):\n`;
            table += 'ID | Route | Type | Address\n';
            table += '----------------------------------------\n';

            criticalItems.forEach(record => {
                const shortAddress = record.address.length > 35
                    ? record.address.substring(0, 32) + '...'
                    : record.address;
                table += `${record.relatedDelivery} | ${record.routeCode || '-'} | ${record.pickupType} | ${shortAddress}\n`;
            });
            table += '\n';
        }

        if (nonCriticalItems.length > 0) {
            table += `ðŸ“¦ OTHER PICKUPS (${nonCriticalItems.length} items):\n`;

            // Raggruppa per route per compattezza
            const routeGroups = {};
            nonCriticalItems.forEach(record => {
                const route = record.routeCode || 'NO-ROUTE';
                const type = record.pickupType;
                const key = `${route}-${type}`;

                if (!routeGroups[key]) {
                    routeGroups[key] = {
                        route: route,
                        type: type,
                        count: 0,
                        items: []
                    };
                }
                routeGroups[key].count++;
                routeGroups[key].items.push(record.relatedDelivery);
            });

            Object.keys(routeGroups).sort().forEach(key => {
                const group = routeGroups[key];
                table += `${group.route} (${group.type}): ${group.count} items\n`;

                // Mostra primi 3 ID per riferimento
                if (group.items.length <= 3) {
                    table += `  ${group.items.join(', ')}\n`;
                } else {
                    table += `  ${group.items.slice(0, 3).join(', ')}, +${group.items.length - 3} more\n`;
                }
            });
        }
    }

    return table;
}


// âœ… FUNZIONE PER TABELLA HTML (PREVIEW)
function generateHTMLEmailTable(records) {
    if (!records || records.length === 0) {
        return '<p style="color: #666; font-style: italic;">No data available for this DSP.</p>';
    }

    // Sort records: critical items first (days = 1), then by route
    const sortedRecords = records.sort((a, b) => {
        if (a.fdpsDays === 1 && b.fdpsDays !== 1) return -1;
        if (b.fdpsDays === 1 && a.fdpsDays !== 1) return 1;

        const routeA = a.routeCode || '';
        const routeB = b.routeCode || '';
        return routeA.localeCompare(routeB);
    });

    let table = `
        <table style="
            width: 100%;
            border-collapse: collapse;
            font-family: Arial, sans-serif;
            font-size: 12px;
            margin: 15px 0;
        ">
            <thead>
                <tr style="background-color: #f8f9fa;">
                    <th style="border: 1px solid #dee2e6; padding: 10px 8px; text-align: center; font-weight: 600; color: #495057; background-color: #e9ecef; min-width: 80px;">PickUp Days</th>
                    <th style="border: 1px solid #dee2e6; padding: 10px 8px; text-align: left; font-weight: 600; color: #495057; background-color: #e9ecef;">Related Delivery</th>
                    <th style="border: 1px solid #dee2e6; padding: 10px 8px; text-align: left; font-weight: 600; color: #495057; background-color: #e9ecef;">Route</th>
                    <th style="border: 1px solid #dee2e6; padding: 10px 8px; text-align: left; font-weight: 600; color: #495057; background-color: #e9ecef;">Type</th>
                    <th style="border: 1px solid #dee2e6; padding: 10px 8px; text-align: left; font-weight: 600; color: #495057; background-color: #e9ecef;">Address</th>
                </tr>
            </thead>
            <tbody>
    `;

    sortedRecords.forEach(record => {
        const isCritical = record.fdpsDays === 1;
        const rowStyle = isCritical
            ? 'background-color: #fff5f5; border-left: 4px solid #dc3545;'
            : 'background-color: #ffffff;';

        const criticalText = isCritical ? 'ðŸ”´ ' : '';
        const daysStyle = isCritical
            ? 'color: #dc3545; font-weight: 700; font-size: 13px;'
            : 'color: #495057;';

        table += `
            <tr style="${rowStyle}">
                <td style="border: 1px solid #dee2e6; padding: 8px; text-align: center; font-weight: 600; ${daysStyle}">${record.fdpsDays > 0 ? record.fdpsDays : '-'}</td>
                <td style="border: 1px solid #dee2e6; padding: 8px; font-family: monospace; font-size: 11px; color: #495057;">${criticalText}${record.relatedDelivery}</td>
                <td style="border: 1px solid #dee2e6; padding: 8px; font-weight: 500; color: #495057;">${record.routeCode || '-'}</td>
                <td style="border: 1px solid #dee2e6; padding: 8px; color: #495057;">${record.pickupType}</td>
                <td style="border: 1px solid #dee2e6; padding: 8px; color: #495057; max-width: 300px; word-wrap: break-word;">${record.address}</td>
            </tr>
        `;
    });

    table += `
            </tbody>
        </table>
    `;

    // Add critical items summary
    const criticalCount = records.filter(r => r.fdpsDays === 1).length;
    if (criticalCount > 0) {
        table += `
            <div style="
                margin: 15px 0;
                padding: 12px;
                background-color: #fff3cd;
                border: 1px solid #ffeaa7;
                border-radius: 4px;
                border-left: 4px solid #f39c12;
            ">
                <strong style="color: #856404;">âš ï¸ ${criticalCount} CRITICAL ITEMS (1 day)</strong>
                <span style="color: #856404;"> - Marked with ðŸ”´ and highlighted in red</span>
            </div>
        `;
    }

    return table;
}

// âœ… FUNZIONE PER TESTO SEMPLICE (COPY-PASTE)
function generateSimpleEmailList(records) {
    if (!records || records.length === 0) {
        return 'No data available for this DSP.\n';
    }

    // Sort records: critical items first (days = 1), then by route
    const sortedRecords = records.sort((a, b) => {
        if (a.fdpsDays === 1 && b.fdpsDays !== 1) return -1;
        if (b.fdpsDays === 1 && a.fdpsDays !== 1) return 1;

        const routeA = a.routeCode || '';
        const routeB = b.routeCode || '';
        return routeA.localeCompare(routeB);
    });

    let emailContent = '';

    // Critical items first
    const criticalItems = sortedRecords.filter(r => r.fdpsDays === 1);
    if (criticalItems.length > 0) {
        emailContent += `ðŸ”´ CRITICAL ITEMS (${criticalItems.length} items - 1 day pickup):\n\n`;

        criticalItems.forEach((record, index) => {
            emailContent += `${index + 1}. ${record.relatedDelivery}\n`;
            emailContent += `   Route: ${record.routeCode || 'N/A'} | Type: ${record.pickupType}\n`;
            emailContent += `   Address: ${record.address}\n\n`;
        });
    }

    // Non-critical items
    const nonCriticalItems = sortedRecords.filter(r => r.fdpsDays !== 1);
    if (nonCriticalItems.length > 0) {
        emailContent += `ðŸ“¦ OTHER PICKUPS (${nonCriticalItems.length} items):\n\n`;

        nonCriticalItems.forEach((record, index) => {
            const days = record.fdpsDays > 0 ? `${record.fdpsDays} days` : 'N/A';
            emailContent += `${index + 1}. ${record.relatedDelivery} (${days})\n`;
            emailContent += `   Route: ${record.routeCode || 'N/A'} | Type: ${record.pickupType}\n`;
            emailContent += `   Address: ${record.address}\n\n`;
        });
    }

    return emailContent;
}

// âœ… EXPORT FUNCTION CON DEBUG E GLOBAL SCOPE - AGGIORNATA SENZA POPUP
function exportToCSV() {
    console.log('[EXPORT DEBUG] Starting export...');

    const table = document.getElementById('main-table');
    const tbody = table.querySelector('#table-body');

    console.log('[EXPORT DEBUG] Elements:', {
        table: !!table,
        tbody: !!tbody
    });

    if (!table || !tbody) {
        alert('Export error: Table elements not found');
        return;
    }

    const visibleRows = tbody.querySelectorAll('tr:not([style*="display: none"])');
    console.log('[EXPORT DEBUG] Visible rows:', visibleRows.length);

    if (visibleRows.length === 0) {
        alert('No data to export');
        return;
    }

    // âœ… HEADER CSV FISSO COME NELLO SCRIPT SCC
    const headers = [
        'Tracking ID',
        'Related Delivery',
        'DSP',
        'Route',
        'Transporter ID',
        'Pick up Type',
        'Complete Address',
        'PickUp Days',
        'Last Date Pickup',
        'Last Status Pickup',
        'Last Reason Pickup'
    ];

    let csv = headers.join(',') + '\n';
    console.log(`[EXPORT DEBUG] Export columns: ${headers.join(', ')}`);

   // âœ… USA I DATI PROCESSATI INVECE DELLA TABELLA HTML
if (scriptState.currentData.processedResults && scriptState.currentData.processedResults.length > 0) {
    console.log('[EXPORT DEBUG] Using processed results data');

    scriptState.currentData.processedResults.forEach((record, rowIndex) => {
        console.log(`[EXPORT DEBUG] Processing row ${rowIndex + 1} from data`);

        const rowData = [
            record.trackingId || '',
            record.relatedDelivery || '',
            record.dsp || '',
            record.routeCode || '',
            record.transporterId || '',
            record.pickupType || '',
            record.address || '',
            record.fdpsDays > 0 ? record.fdpsDays : '',
            record.lastDatePickup || '',
            record.lastPickup || '',
            record.lastReasonPickup || ''
        ];

        // âœ… PULIZIA SPECIALE PER TRACKING IDS (prime due colonne)
        const cleanedRowData = rowData.map((value, index) => {
            let text = String(value).trim();

            if (index === 0 || index === 1) {
                const originalText = text;
                text = text.replace(/\s+/g, '').replace(/[^\w]/g, '').toUpperCase();
                console.log(`[EXPORT CLEAN] Tracking cleaned: "${originalText}" -> "${text}"`);
            } else {
                text = text.replace(/\s+/g, ' ').trim();
            }

            // âœ… ESCAPE CSV se necessario
            if (text.includes(',') || text.includes('"') || text.includes('\n')) {
                text = `"${text.replace(/"/g, '""')}"`;
            }

            return text;
        });

        csv += cleanedRowData.join(',') + '\n';
    });
} else {
    console.log('[EXPORT DEBUG] No processed data available, using table fallback');
    // âœ… FALLBACK: DATI CON PULIZIA AVANZATA (STILE SCC)
    visibleRows.forEach((row, rowIndex) => {
        const cells = Array.from(row.cells);
        console.log(`[EXPORT DEBUG] Processing row ${rowIndex + 1}, cells: ${cells.length}`);

        const rowData = cells.map((cell, index) => {
            let text = cell.textContent.trim();

            // âœ… PULIZIA SPECIALE PER TRACKING IDS (prime due colonne)
            if (index === 0 || index === 1) {
                const originalText = text;
                text = text.replace(/\s+/g, '').replace(/[^\w]/g, '').toUpperCase();
                console.log(`[EXPORT CLEAN] Tracking cleaned: "${originalText}" -> "${text}"`);
            } else {
                text = text.replace(/\s+/g, ' ').trim();
            }

            // âœ… ESCAPE CSV se necessario
            if (text.includes(',') || text.includes('"') || text.includes('\n')) {
                text = `"${text.replace(/"/g, '""')}"`;
            }

            return text;
        });

        // âœ… AGGIUNGI COLONNE VUOTE PER I NUOVI CAMPI
        while (rowData.length < headers.length) {
            rowData.push('');
        }

        csv += rowData.join(',') + '\n';
    });
}

console.log(`[EXPORT DEBUG] CSV content length: ${csv.length}`);

// âœ… DOWNLOAD CON NOME STILE SCC
try {
    const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    const now = new Date();
    const formattedDate = now.toISOString().replace('T', '-').replace(/:/g, '').replace(/\..+/, '');
    link.download = `FDPS_INFO_SENDER_${formattedDate}.csv`;

    console.log(`[EXPORT DEBUG] Download filename: ${link.download}`);

    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    console.log(`[EXPORT DEBUG] CSV exported successfully with ${headers.length} columns and ${visibleRows.length || scriptState.currentData.processedResults?.length || 0} records`);

    // âœ… FEEDBACK VISIVO SENZA POPUP
    const exportButton = document.getElementById('exportButton');
    if (exportButton) {
        const originalText = exportButton.innerHTML;
        const originalBg = exportButton.style.backgroundColor;

        exportButton.innerHTML = 'âœ… Downloaded!';
        exportButton.style.backgroundColor = '#28a745';
        exportButton.disabled = true;

        setTimeout(() => {
            exportButton.innerHTML = originalText;
            exportButton.style.backgroundColor = originalBg;
            exportButton.disabled = false;
        }, 2000);
    }

} catch (downloadError) {
    console.error('[EXPORT DEBUG] Download error:', downloadError);
    alert(`Export error: ${downloadError.message}`);
}
}

// âœ… RENDI LA FUNZIONE GLOBALE PER DEBUG E ACCESSO
window.exportToCSV = exportToCSV;

// âœ… SETUP PREVIEW MODAL - AGGIORNATO PER RESET CORRETTO
function setupPreviewModal() {
    const modal = document.getElementById('communication-preview-modal');
    const closeBtn = document.getElementById('close-modal');
    const cancelBtn = document.getElementById('cancel-send');
    const confirmBtn = document.getElementById('confirm-send');

    if (!modal) return;

    // Close modal handlers
    const closeModal = () => {
        modal.style.display = 'none';
        modal.removeAttribute('data-mode');
        modal.removeAttribute('data-dsp');

        // âœ… RESET COMPLETO DEL MODAL
        const modalDialog = modal.querySelector('#modal-dialog');
        if (modalDialog) {
            modalDialog.style.cssText = `
                width: 90%;
                max-width: 1000px;
                min-height: 300px;
                background: white;
                border-radius: 8px;
                box-shadow: 0 4px 24px rgba(0,0,0,0.3);
                overflow: hidden;
                display: flex;
                flex-direction: column;
                animation: modalFadeIn 0.3s ease;
                margin: 0 auto;
                position: relative;
                top: auto;
                left: auto;
            `;
        }

        modal.style.cssText = `
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 99999;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
            align-items: center;
            justify-content: center;
        `;
    };

    closeBtn.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);

    // Close on backdrop click
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });

    // ESC key to close
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.style.display === 'flex') {
            closeModal();
        }
    });

    // Confirm send handler
    confirmBtn.addEventListener('click', () => {
        const mode = modal.getAttribute('data-mode');
        const dspCode = modal.getAttribute('data-dsp');

        if (mode === 'email') {
            executeSendEmail(dspCode);
        } else if (mode === 'chime') {
            executeSendChime(dspCode);
        }

        closeModal();
    });
}

console.log('[FDPS] END SECTION 10: Data processing');


// ================================================================================================
// SECTION 11: INITIALIZATION AND SETUP
// ================================================================================================

console.log('[FDPS] START SECTION 11: Initialization and setup');

function initializeUI() {
    const toggleButton = createToggleButton();
    const container = createUI();

    // Remove existing elements if they exist
    const existingButton = document.getElementById('fdpsToggle');
    const existingContainer = document.getElementById('fdpsContainer');
    if (existingButton) existingButton.remove();
    if (existingContainer) existingContainer.remove();

    // Find the target div and insert the button
    const targetDiv = document.querySelector('div[mrdn-masthead-actions]');
    if (targetDiv) {
        targetDiv.insertBefore(toggleButton, targetDiv.firstChild);
    } else {
        document.body.appendChild(toggleButton);
    }

    document.body.appendChild(container);

    // Setup toggle button click event
    toggleButton.addEventListener('click', () => {
        container.style.display = container.style.display === 'none' ? 'block' : 'none';
    });

    // Setup UI event listeners
    setupUIEventListeners(container);

    // Setup drag functionality
    const titleBar = container.querySelector('#fdpsDragHandle');
    setupDragFunctionality(container, titleBar);

    return { container, toggleButton };
}

function initializeScript() {
    if (scriptState.initialized) {
        debugLog('Script already initialized');
        return;
    }

    debugLog('Creating UI elements');
    initializeUI();
    addCustomStyles();

    // âœ… AVVIA IL CHECK AUTOMATICO DEGLI AGGIORNAMENTI DOPO 3 SECONDI
    setTimeout(() => {
        checkForUpdates(false); // Check automatico (non forzato)
    }, 3000);

    // âœ… TEST TEMPORANEO - FORZA IL CHECK PER DEBUG - RIMUOVERE DOPO IL TEST
    setTimeout(() => {
        console.log('[FDPS] *** TESTING UPDATE SYSTEM ***');
        console.log('[FDPS] Current version:', GM_info.script.version);

        // Reset dei valori per test
        GM_setValue(UPDATE_CONFIG.LAST_CHECK_KEY, 0); // Force check
        GM_setValue(UPDATE_CONFIG.DISMISSED_VERSION_KEY, ''); // Reset dismissed

        // Forza il check
        console.log('[FDPS] Forcing update check...');
        checkForUpdates(true);
    }, 5000); // Dopo 5 secondi

    scriptState.initialized = true;

    // âœ… LISTENER PER STORAGE EVENTS
    window.addEventListener('storage', (event) => {
        if (event.key === 'fdps_update_completed' && event.newValue) {
            console.log('[FDPS] Detected update completion in another tab');

            // Verifica se questo Ã¨ il tab originale
            const originalTabId = sessionStorage.getItem('fdps_original_tab_id');
            if (originalTabId) {
                console.log('[FDPS] This appears to be the original tab');

                // Pulisci lo storage
                sessionStorage.removeItem('fdps_original_tab_id');
                localStorage.removeItem('fdps_update_completed');

                // Focus e mostra notifica
                window.focus();
                setTimeout(() => {
                    showUpdateCompletionMessage();
                }, 500);
            }
        }
    });

    debugLog('Initialization completed');
}

console.log('[FDPS] END SECTION 11: Initialization and setup');



// ================================================================================================
// SECTION 12: MAIN EXECUTION
// ================================================================================================

console.log('[FDPS] START SECTION 12: Main execution');

// Initialize script
if (document.readyState === 'complete' || document.readyState === 'interactive') {
    debugLog('Document ready, initializing immediately');
    initializeScript();
}

// Add event listener for DOMContentLoaded
document.addEventListener('DOMContentLoaded', () => {
    debugLog('DOMContentLoaded event fired');
    initializeScript();
});

// Final fallback with setTimeout
setTimeout(() => {
    debugLog('Timeout initialization');
    initializeScript();
}, 2000);

// Add a mutation observer to handle dynamic page loads
const observer = new MutationObserver((mutations, obs) => {
    if (document.getElementById('fdpsToggle')) {
        return;
    }
    debugLog('DOM mutation detected, reinitializing');
    initializeScript();
});

observer.observe(document.body, {
    childList: true,
    subtree: true
});

console.log('[FDPS] END SECTION 12: Main execution');
console.log('[FDPS] Script initialization completed');

})();
